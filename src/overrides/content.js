import{ui,get,lib,_status,game}from"noname";function e(e){}function a(e){return[...e.slice(0,-2),async(event,trigger,player)=>{let{cards:e,gaintag:a}=event;const i=player.node.handcards1,t=document.createDocumentFragment();for(let d=0;d<e.length;d++){const card=e[d];if(lib.config.sort_card(card),lib.config.reverse_sort,["o","d"].includes(get.position(card,!0))&&card.addKnower("everyone"),card.fix(),card.style.transform="",card.parentNode!=i){a.forEach(e=>card.addGaintag(e)),event.knowers&&card.addKnower(event.knowers),t.appendChild(card),_status.discarded&&_status.discarded.remove(card);for(let e=0;e<card.vanishtag.length;e++)"_"!=card.vanishtag[e][0]&&card.vanishtag.splice(e--,1)}else e.splice(d--,1)}const s=window.decadeUI,r=function(e,r){e.duiMod=event.source,player==game.me&&(s.layoutHandDraws(e),s.queueNextFrameTick(s.layoutHand,s),game.addVideo("gain12",player,[get.cardsInfo(t.childNodes),a]));const d=player.getCards("s");d.length?i.insertBefore(t,d[0]):i.appendChild(t),game.broadcast(function(e,a,i,t){e.directgain(a,null,t),_status.cardPileNum=i},player,e,ui.cardPile.childNodes.length,a),!0!==r?setTimeout(function(e){e.update(),game.resume()},get.delayx(400,400)+66,player):player.update()};if("draw"==event.animate)game.pause(),r(e),player.$draw(e.length);else if("gain"==event.animate)game.pause(),r(e),player.$gain(e,event.log);else if("gain2"==event.animate||"draw2"==event.animate)game.pause(),r(e),player.$gain2(e,event.log);else if("give"==event.animate||"giveAuto"==event.animate){game.pause(),r(e);const a=event.losing_map;if("give"==event.animate)for(const e in a){(_status.connectMode?lib.playerOL:game.playerMap)[e].$give(a[e][0],player,event.log)}else for(const e in a){const i=(_status.connectMode?lib.playerOL:game.playerMap)[e];a[e][1].length&&i.$giveAuto(a[e][1],player,event.log),a[e][2].length&&i.$give(a[e][2],player,event.log)}}else if("function"==typeof event.animate){const a=event.animate(event);game.pause(),setTimeout(function(){r(e,!0),game.resume()},get.delayx(a,a))}else r(e,!0)},async(event,trigger,player)=>{event.updatePile&&game.updateRoundNumber()}]}function i(){return[async(event,trigger,player)=>{const e=`${get.translation(player)}的${event.judgestr}判定`;event.videoId=lib.status.videoId++;let a,i=event.directresult;if(i||(i=player.getTopCards?player.getTopCards()[0]:get.cards()[0]),!i)return void event.finish();const t=get.owner(i);if(t)a=t.lose(i,"visible",ui.ordering);else{const e=game.cardsGotoOrdering(i);event.position!=ui.discardPile&&(e.noOrdering=!0),a=e}return player.judging.unshift(i),game.addVideo("judge1",player,[get.cardInfo(player.judging[0]),e,event.videoId]),game.broadcastAll(function(e,card,a,i){const t=game.online?{}:_status.event;game.chess?t.node=card.copy("thrown","center",ui.arena).addTempClass("start"):t.node=e.$throwordered2(card.copy(),!0),lib.cardOL&&(lib.cardOL[i]=t.node),t.node.cardid=i,window.decadeUI||(ui.arena.classList.add("thrownhighlight"),t.node.classList.add("thrownhighlight"))},player,player.judging[0],event.videoId,get.id()),game.log(player,"进行"+event.judgestr+"判定，亮出的判定牌为",player.judging[0]),await game.delay(2),event.noJudgeTrigger||await event.trigger("judge"),a.forResult()},async(event,trigger,player)=>{if(event.result={card:player.judging[0],name:player.judging[0].name,number:get.number(player.judging[0]),suit:get.suit(player.judging[0]),color:get.color(player.judging[0]),node:event.node},event.fixedResult)for(const i in event.fixedResult)event.result[i]=event.fixedResult[i];if(event.result.judge=event.judge(event.result),event.result.judge>0?event.result.bool=!0:event.result.judge<0?event.result.bool=!1:event.result.bool=null,player.judging.shift(),game.checkMod(player,event.result,"judge",player),event.judge2){const e=event.judge2(event.result);"boolean"==typeof e&&player.tryJudgeAnimate(e)}0!=event.clearArena&&game.broadcastAll(ui.clear),game.broadcast(function(){window.decadeUI||ui.arena.classList.remove("thrownhighlight")}),game.addVideo("judge2",null,event.videoId),game.log(player,"的判定结果为",event.result.card);const e=event.trigger("judgeFixing");event.triggerMessage("judgeresult");let a=null;if(event.callback){const e=game.createEvent("judgeCallback",!1);e.player=player,e.card=event.result.card,e.judgeResult=get.copy(event.result),e.setContent(event.callback),a=e}else get.owner(event.result.card)||event.position!=ui.discardPile&&event.position.appendChild(event.result.card);await e,event.next.includes(a)&&await a}]}function t(e){return[async(event,trigger,player)=>{const e=event.getParent();"discard"==e.name&&"discard"==event.type||"loseToDiscardpile"==e.name&&"loseToDiscardpile"==event.type?(!1===e.delay&&(event.delay=!1),null==event.animate&&(event.animate=e.animate)):(event.delay=!1,null==event.blameEvent&&(event.animate=!1))},async(event,trigger,player)=>{let{cards:e}=event;event.vcards={cards:[],es:[],js:[]},event.vcard_cards=[],event.gaintag_map={};const a=[],i=[],t=[],s=[],r=[],d=[];event.insert_card&&event.position==ui.cardPile&&event.cards.reverse();const n=player.getCards("hejsx");event.stockcards=e.slice(0);for(let l=0;l<e.length;l++){let o=[e[l]];if(n.includes(e[l])){if(e[l].parentNode)if(e[l].parentNode.classList.contains("equips")){e[l].throwWith=e[l].original="e";const a=e[l][e[l].cardSymbol];if(a){if(e[l].isViewAsCard){let t=a.cards;o.addArray(t),event.vcard_cards.addArray(t),t.forEach(t=>{t.throwWith=t.original="e",delete t.destiny,i.push(t),event.vcard_map.set(t,a||get.autoViewAs(e[l],void 0,!1))})}else i.push(e[l]),event.vcard_map.set(e[l],a||get.autoViewAs(e[l],void 0,!1)),event.vcard_cards.add(e[l]);event.vcards.cards.push(e[l]),event.vcards.es.push(e[l])}}else if(e[l].parentNode.classList.contains("judges")){e[l].throwWith=e[l].original="j";const a=e[l][e[l].cardSymbol];if(a){if(e[l].isViewAsCard){let i=a.cards;o.addArray(i),event.vcard_cards.addArray(i),i.forEach(i=>{i.throwWith=i.original="j",delete i.destiny,t.push(i),event.vcard_map.set(i,a||get.autoViewAs(e[l],void 0,!1))})}else t.push(e[l]),event.vcard_map.set(e[l],a||get.autoViewAs(e[l],void 0,!1)),event.vcard_cards.add(e[l]);event.vcards.cards.push(e[l]),event.vcards.js.push(e[l])}}else e[l].parentNode.classList.contains("expansions")?(e[l].throwWith=e[l].original="x",r.push(e[l]),event.vcard_map.set(e[l],get.autoViewAs(e[l],void 0,!1)),e[l].gaintag&&e[l].gaintag.length&&d.addArray(e[l].gaintag)):e[l].parentNode.classList.contains("handcards")?e[l].classList.contains("glows")?(e[l].throwWith=e[l].original="s",s.push(e[l]),event.vcard_map.set(e[l],get.autoViewAs(e[l],void 0,!1))):(e[l].throwWith=e[l].original="h",a.push(e[l]),event.vcard_map.set(e[l],get.autoViewAs(e[l],void 0,player))):e[l].throwWith=e[l].original=null;for(let e=0;e<o.length;e++){if(o[e].gaintag&&o[e].gaintag.length){event.gaintag_map[o[e].cardid]=o[e].gaintag.slice(0);o[e].gaintag.filter(e=>!e.startsWith("eternal_")).forEach(a=>o[e].removeGaintag(a))}o[e].style.transform+=" scale(0.2)",o[e].classList.remove("glow"),o[e].classList.remove("glows"),o[e].recheck();const a=lib.card[o[e].name];if("_destroy"in o[e]){if(o[e]._destroy){o[e].delete(),o[e].destroyed=o[e]._destroy;continue}}else if("destroyed"in o[e]){if(!1!==event.getlx&&event.position&&o[e].willBeDestroyed(event.position.id,null,event)){o[e].selfDestroy(event);continue}}else if(a.destroy){o[e].delete(),o[e].destroyed=a.destroy;continue}event.position?(_status.discarded&&(event.position==ui.discardPile?_status.discarded.add(o[e]):_status.discarded.remove(o[e])),event.insert_index?(o[e].fix(),event.position.insertBefore(o[e],event.insert_index(event,o[e]))):event.insert_card?(o[e].fix(),event.position.insertBefore(o[e],event.position.firstChild)):event.position==ui.cardPile?(o[e].fix(),event.position.appendChild(o[e])):o[e].goto(event.position)):o[e].remove()}}else e.splice(l--,1)}const o=window.decadeUI;if(player==game.me&&o.queueNextFrameTick(o.layoutHand,o),ui.updatej(player),game.broadcast((e,a,i)=>{for(let t=0;t<a.length;t++)a[t].removeGaintag(!0),a[t].classList.remove("glow"),a[t].classList.remove("glows"),a[t].fix(),a[t].remove();e==game.me&&ui.updatehl(),ui.updatej(e),_status.cardPileNum=i},player,e.slice(),ui.cardPile.childNodes.length),0!=event.animate){const a=event.getParent();if(a.discardid=lib.status.videoId++,game.broadcastAll(function(e,a,i,t){const s=a.slice().map(e=>e.cards?e.cards:[e]).flat();s.duiMod=!0,t&&e.$throw(s,null,"nobroadcast");const r=[];r._discardtime=get.time();for(let d=0;d<s.length;d++)s[d].clone&&r.push(s[d].clone);ui.todiscard[i]=r},player,e,a.discardid,event.visible),lib.config.sync_speed&&e[0]?.clone)if(0!=a.delay){const i=get.time();a.waitingForTransition=i,e[0].clone.listenTransition(function(){_status.waitingForTransition==i&&_status.paused&&game.resume(),delete a.waitingForTransition})}else if(a.getParent().discardTransition){delete a.getParent().discardTransition;const i=get.time();a.getParent().waitingForTransition=i,e[0].clone.listenTransition(function(){_status.waitingForTransition==i&&_status.paused&&game.resume(),delete a.getParent().waitingForTransition})}}if(game.addVideo("lose",player,[get.cardsInfo(a),get.cardsInfo(i),get.cardsInfo(t),get.cardsInfo(s)]),event.cards2=a.concat(i),e.removeArray(event.vcards.cards),e.addArray(event.vcard_cards),player.getHistory("lose").push(event),game.getGlobalHistory().cardMove.push(event),player.update(),game.addVideo("loseAfter",player),event.num=0,event.position==ui.ordering){const a=event.relatedEvent||event.getParent();if(a.orderingCards||(a.orderingCards=[]),!a.noOrdering&&!a.cardsOrdered){a.cardsOrdered=!0;const e=game.createEvent("orderingDiscard",!1);event.next.remove(e),a.after.push(e),e.relatedEvent=a,e.setContent("orderingDiscard")}a.noOrdering||a.orderingCards.addArray(e)}else event.position==ui.cardPile&&game.updateRoundNumber();if(d.length)for(const l of d)player[lib.skill[l]&&lib.skill[l].mark||player.hasCard(card=>card.hasGaintag(l),"x")?"markSkill":"unmarkSkill"](l);event.hs=a,event.es=i,event.js=t,event.ss=s,event.xs=r,game.clearCardKnowers(a),a.length&&!event.visible&&player.getCards("h").forEach(e=>{e.clearKnowers()})},...e.slice(2)]}export{i as contentJudge,a as createContentGain,t as createContentLose,e as setBaseContentMethods};
