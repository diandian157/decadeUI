import{game,get,lib,_status,ui}from"noname";import{applyCardBorder as e}from"../../ui/cardStyles.js";let t=null,n=null;function a(){return n||(n=window.decadeUI),n}function d(e){t=e}function r(n,d,r){if(game.chess)return t.call(this,n,d,r);let i,o;var event;if(!1!==d&&"nobroadcast"!==d&&game.broadcast(function(e,t,n,a){e.$draw(t,n,a)},this,n,d,r),"cards"==get.itemtype(n)?(i=n.concat(),o=!0):"card"==get.itemtype(n)?(i=[n],o=!0):i=new Array("number"==typeof n?n:1),!1!==d&&(o?game.addVideo("drawCard",this,get.cardsInfo(i)):game.addVideo("draw",this,n)),_status.event&&_status.event.name&&("gain"==(event=_status.event).name||event.name.includes("raw")||(o=!0)),game.me==this&&!o)return;const s=document.createDocumentFragment();let card;const c=a(),player=this;for(let t=0;t<i.length;t++)card=i[t],card=null==card?c.element.create("card thrown drawingcard"):card.copy("thrown","drawingcard",!1),card.fixed=!0,player!==game.me&&e(card,player),i[t]=card,s.appendChild(card);c.layoutDrawCards(i,player,!0),ui.arena.appendChild(s),c.queueNextFrameTick(function(){c.layoutDrawCards(i,player),c.delayRemoveCards(i,460,220)})}function i(t,n){let d=get.itemtype(t);if("cards"!=d){if("card"!=d)return;d="cards",t=[t]}!0===n&&game.log(this,"获得了",t),game.broadcast(function(e,t){e.$gain2(t)},this,t);const r=[],i=[];let card,o;const player=this;for(let a=0;a<t.length;a++)o=t[a].clone,card=t[a].copy("thrown","gainingcard"),card.fixed=!0,player!==game.me&&e(card,player),o&&o.parentNode==ui.arena?(card.scaled=!0,card.style.transform=o.style.transform,r.push(card)):i.push(card);if(r.length&&game.addVideo("gain2",this,get.cardsInfo(r)),i.length&&game.addVideo("drawCard",this,get.cardsInfo(i)),t.duiMod&&this==game.me)return;t=r.concat(i);const s=a();s.layoutDrawCards(i,this,!0);const c=document.createDocumentFragment();for(let e=0;e<t.length;e++)c.appendChild(t[e]);ui.arena.appendChild(c),s.queueNextFrameTick(function(){s.layoutDrawCards(t,player),s.delayRemoveCards(t,460,220)})}function o(e,t,n,d){let r;const i=e.duiMod&&game.me==t;if("number"==typeof e)r="number",e=new Array(e);else if(r=get.itemtype(e),"cards"==r)e=e.concat();else{if("card"!=r)return;e=[e]}if(!1!==d){let n=e;"number"==r?(n=e.length,game.addVideo("give",this,[n,t.dataset.position])):game.addVideo("giveCard",this,[get.cardsInfo(n),t.dataset.position]),game.broadcast(function(e,t,n,a){e.$give(t,n,!1,a)},this,n,t,d)}if(0!=n&&("number"==r?game.log(t,"从",this,"获得了"+get.cnNumber(e.length)+"张牌"):game.log(t,"从",this,"获得了",e)),this.$givemod)return void this.$givemod(e,t);if(i)return;let card;const o=a(),s=o.boundsCaches.hand;s.check();const c=[],player=this,l=document.createDocumentFragment();for(let a=0;a<e.length;a++){if(card=e[a],card){const e=card.copy("card","thrown","gainingcard",!1);let t=player==game.me;t&&(t=card.throwWith?"h"==card.throwWith||"s"==card.throwWith:card.parentNode==player.node.handcards1),t?(e.tx=Math.round(s.x+card.tx),e.ty=Math.round(s.y+30+card.ty),e.scaled=!0,e.style.transform="translate("+e.tx+"px,"+e.ty+"px) scale("+s.cardScale+")"):c.push(e),card=e}else card=o.element.create("card thrown gainingcard"),c.push(card);e[a]=card,e[a].fixed=!0,l.appendChild(e[a])}c.length&&o.layoutDrawCards(c,player),ui.arena.appendChild(l),o.queueNextFrameTick(function(){o.layoutDrawCards(e,t),o.delayRemoveCards(e,460,220)})}function s(e,t,n,d){let r;const i=e.duiMod&&game.me==this&&!d;if("number"==typeof e)r="number",e=new Array(e);else if(r=get.itemtype(e),"cards"==r)e=e.concat();else if("card"==r)e=[e];else{const t=_status.event;if(t&&t.card&&t.cards===e){const n=ui.create.card().init([t.card.suit,t.card.number,t.card.name,t.card.nature]);"none"==t.card.suit&&(n.node.suitnum.style.display="none"),n.dataset.virtual=1,e=[n]}}let card,o;const player=this,s=a(),c=s.boundsCaches.hand;c.check();for(let a=0;a<e.length;a++)card=e[a],card?(o=card.copy("thrown"),!i||"h"!=card.throwWith&&"s"!=card.throwWith||(o.tx=Math.round(c.x+card.tx),o.ty=Math.round(c.y+30+card.ty),o.scaled=!0,o.throwordered=!0,o.style.transform="translate("+o.tx+"px,"+o.ty+"px) scale("+c.cardScale+")"),card=o):(card=s.element.create("card infohidden infoflip"),card.moveTo=lib.element.card.moveTo,card.moveDelete=lib.element.card.moveDelete),e[a]=card;!1!==n&&("nobroadcast"!==n&&game.broadcast(function(e,t,n,a,d){e.$throw(t,n,a,d)},this,e,0,n,d),game.addVideo("throw",this,[get.cardsInfo(e),0,d])),e.sort((e,t)=>void 0===e.tx&&void 0===t.tx?0:void 0===e.tx?decadeUI.config.rightLayout?-1:1:void 0===t.tx?decadeUI.config.rightLayout?1:-1:e.tx-t.tx);for(let a=0;a<e.length;a++)(e=>{player.$throwordered2(e,d)})(e[a]);return game.chess&&this.chessFocus(),e[e.length-1]}function c(card,t){_status.connectMode&&(ui.todiscard=[]);const n=a();if(void 0===card.throwordered){const e=n.boundsCaches.arena;let a,d;e.updated||e.update(),this.checkBoundsCache(),t?(a=(e.width-e.cardWidth)/2-.08*e.width,d=(e.height-e.cardHeight)/2):(a=(this.cacheWidth-e.cardWidth)/2+this.cacheLeft,d=(this.cacheHeight-e.cardHeight)/2+this.cacheTop),card.style.transform=`translate(${Math.round(a)}px,${Math.round(d)}px) scale(${e.cardScale})`}else card.throwordered=void 0;if(card.classList.add("thrown"),card.fixed)return ui.arena.appendChild(card);let d=card.querySelector(".used-info");return null==d&&(d=card.appendChild(n.element.create("used-info"))),card.$usedtag=d,e(card,this,this===game.me),ui.thrown.push(card),ui.arena.appendChild(card),n.tryAddPlayerCardUseTag(card,this,_status.event),n.queueNextFrameTick(n.layoutDiscard,n),card}function l(card){game.addVideo("phaseJudge",this,get.cardInfo(card));const player=this;if(card[card.cardSymbol]?.cards?.length){const e=card[card.cardSymbol].cards;if(player.$throw(e),lib.config.low_performance&&e[0]&&e[0].clone){const t=get.time();_status.waitingForTransition=t,e[0].clone.listenTransition(function(){_status.waitingForTransition==t&&_status.paused&&game.resume()}),game.pause()}else a().delay(451)}else{const e=game.createCard(card.name,"虚拟","");if(player.$throw(e),lib.config.low_performance&&e&&e.clone){const t=get.time();_status.waitingForTransition=t,e.clone.listenTransition(function(){_status.waitingForTransition==t&&_status.paused&&game.resume()}),game.pause()}else a().delay(451)}}function u(e,t){if(game.online)return;const card=e,n=1!==t.length||t[0].name!==e.name||!card.isCard;let a;a="card"==get.itemtype(card)&&card.isViewAsCard?card:n?game.createCard(card.name,1==t.length?get.suit(t[0]):"none",1==t.length?get.number(t[0]):0):t[0],game.broadcastAll((e,t,n,a,d)=>{if(t.fix(),!t.isViewAsCard){const e=/* @__PURE__ */Symbol("card");t.cardSymbol=e,t[e]=a}if(t.style.transform="",t.classList.remove("drawinghidden"),delete t._transform,n&&!t.isViewAsCard){t.isViewAsCard=!0,t.destroyLog=!1;for(let t of d)t.goto(ui.special),t.destiny=e.node.judges;t.destroyed&&(t._destroyed_Virtua=t.destroyed),t.destroyed=function(e,t,n,event){if(e._destroyed_Virtua)if("function"==typeof e._destroyed_Virtua){if(!0===e._destroyed_Virtua(e,t,n,event))return!0}else{if(lib.skill[e._destroyed_Virtua])return!n||!n.hasSkill(e._destroyed_Virtua)||(delete e._destroyed_Virtua,!1);if("string"==typeof e._destroyed_Virtua)return e._destroyed_Virtua==t;if(!0===e._destroyed_Virtua)return!0}return("ordering"!=t||!["phaseJudge","executeDelayCardEffect"].includes(event.getParent().name))&&("judge"!=t||void 0)}}if(t.classList.add("drawinghidden"),n){t.cards=d||[],t.viewAs=a.name;const e=lib.translate[t.viewAs+"_bg"]||get.translation(t.viewAs)[0];(t.classList.contains("fullskin")||t.classList.contains("fullborder")||t.classList.contains("fullimage"))&&(t.classList.add("fakejudge"),t.classList.contains("fullimage")&&(t.classList.remove("fullimage"),t.classList.add("fullskin"),t.style.backgroundImage=""),window.decadeUI?t.node.judgeMark.node.judge.innerHTML=e:t.node.background.innerHTML=e)}else delete t.viewAs,t.classList.remove("fakejudge"),window.decadeUI&&(t.node.judgeMark.node.judge.innerHTML=lib.translate[t.name+"_bg"]||get.translation(t.name)[0]);e.node.judges.insertBefore(t,e.node.judges.firstChild);if(["bingliang","lebu","shandian","fulei","hongshui","huoshan","caomu","jlsgqs_shuiyanqijun","jydiy_zouhuorumo","jydiy_yungongliaoshang","xwjh_biguanqingxiu","xwjh_wushisanke","xumou_jsrg","dczixi_bingliang","dczixi_lebu","dczixi_shandian"].includes(t.name)){let e=t.name;const n=lib.translate[t.name+"_bg"]||get.translation(t.name)||"";t.node.judgeMark.node.judge.innerText="",t.node.judgeMark.node.judge.style.fontSize="";const a=("on"===lib.config.extension_十周年UI_newDecadeStyle||"othersOff"===lib.config.extension_十周年UI_newDecadeStyle)&&["bingliang","lebu","shandian"].includes(e)?"1.png":".png",d=`${lib.assetURL}extension/十周年UI/image/ui/judge-mark/`,r=new Image;r.onload=function(){t.node.judgeMark.node.judge.style.backgroundImage=`url("${r.src}")`,t.node.judgeMark.node.judge.innerText="",t.node.judgeMark.node.judge.style.fontSize="0px"},r.onerror=function(){t.node.judgeMark.node.judge.style.backgroundImage=`url("${d}tongyong.png")`,t.node.judgeMark.node.judge.innerText=n?n[0]:""},r.src=`${d}${e}${a}`,t.node.judgeMark.node.judge.style.zIndex="99",t.node.judgeMark.node.judge.parentElement.children[0].style.background="none",t.node.judgeMark.node.judge.parentElement.children[0].style.display="none"}else t.node.judgeMark.node.judge.style.backgroundImage=`url("${lib.assetURL}extension/十周年UI/image/ui/judge-mark/tongyong.png")`;ui.updatej(e)},this,a,n,e,t)}export{u as playerAddVirtualJudge,r as playerDraw,i as playerGain2,o as playerGive,l as playerPhaseJudge,s as playerThrow,c as playerThrowordered2,d as setBasePlayerDraw};
