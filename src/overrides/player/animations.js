import{game,get,lib,ui}from"noname";import{getDui as e}from"./base.js";const t={thunder:["play5","play6"],fire:["play3","play4"],__default:["play1","play2"]};function a(a,n="soil",i,s){const player=this;if("string"==typeof a){if(!(player.getSkills?.(null,!1,!1)||[]).some(e=>{const t=lib.translate[e];return t&&a.includes(t)}))return;game.addVideo("damagepop",player,[a,n,i]),!1!==s&&game.broadcast((e,t,a,n)=>e.$damagepop(t,a,n),player,a,n,i);const e=ui.create.div(".damage.skill-popup",ui.arena);e.dataset.nature=n||"soil";let t=0,o=0,d=player;for(;d&&d!==ui.arena;)t+=d.offsetLeft||0,o+=d.offsetTop||0,d=d.offsetParent;e.style.position="absolute",e.style.left=`${t}px`,e.style.top=`${o+80}px`,e.style.width=`${player.offsetWidth}px`,e.style.zIndex="9999";const r=a.split(""),c=Math.ceil(r.length/2);return r.forEach((t,a)=>{const n=document.createElement("span");n.textContent=t,n.className=a<c?"char-left":"char-right",n.style.animationDelay=.05*a+"s",e.appendChild(n)}),void setTimeout(()=>e.delete(),1500)}if("number"!=typeof a){if(player.damagepopups?.length){const e=player.damagepopups[0];player.appendChild(e),ui.refresh(e),e.classList.add("damageadded"),e.listenTransition(()=>setTimeout(()=>e.delete(),200)),setTimeout(()=>{player.damagepopups.shift(),player.$damagepop()},500)}return}const o=e()?.animation;if(o)if(a<0&&"water"!==n){const e=t[n]||t.__default,i=a<=-2?e[1]:e[0];o.playSpine({name:"effect_shoujidonghua",action:i},{scale:.8,parent:player})}else a>0&&"wood"===n&&o.playSpine("effect_zhiliao",{scale:.7,parent:player})}function n(e){"player"===get.itemtype(e)?game.addVideo("damage",this,e.dataset.position):game.addVideo("damage",this),game.broadcast((player,e)=>player.$damage(e),this,e),this.queueCssAnimation("player-hurt 0.3s")}function i(e,t,a){const n=l([this,t]);game.broadcast((e,t,a,n,i)=>e.$compare(a,t,n,i),this,t,e,a,n),game.addVideo("compare",this,[get.cardInfo(e),t.dataset.position,get.cardInfo(a)]);const{scale:i,centerX:s,y:o}=p();h(e,this,Math.round(s-62),o,i,n,300),setTimeout(()=>{h(a,t,Math.round(s+62),o,i,n,200)},200)}function s(e,t,a){const n=l([this,...t]);game.broadcast((e,t,a,n,i)=>e.$compareMultiple(t,a,n,i),this,e,t,a,n),game.addVideo("compareMultiple",this,[get.cardInfo(e),get.targetsInfo(t),get.cardsInfo(a)]);const{scale:i,centerX:s,y:o}=p(),d=Math.round(s-124*t.length/2);h(e,this,d,o,i,n,300),t.forEach((e,t)=>{setTimeout(()=>{h(a[t],e,d+124*(t+1),o,i,n,200)},200*(t+1))})}function o(t,a){if("players"===get.itemtype(t))return void t.forEach(e=>this.line(e,a));if("player"!==get.itemtype(t))return;if(t===this)return;const player=this,n=e();game.broadcast((e,t,a)=>e.line(t,a),player,t,a),game.addVideo("line",player,[t.dataset.position,a]),player.checkBoundsCache(!0),t.checkBoundsCache(!0);const i=n.boundsCaches.hand;let s,o,d,r;player===game.me?(i.check(),s=ui.arena.offsetWidth/2,o=i.y):(s=player.cacheLeft+player.cacheWidth/2,o=player.cacheTop+player.cacheHeight/2),t===game.me?(i.check(),d=ui.arena.offsetWidth/2,r=i.y):(d=t.cacheLeft+t.cacheWidth/2,r=t.cacheTop+t.cacheHeight/2),game.linexy([s,o,d,r],a,!0)}function d(){this.stopDynamic(),this.node.gainSkill.innerHTML=null,this.node.dieidentity||(this.node.dieidentity=ui.create.div("died-identity",this)),this.node.dieidentity.classList.add("died-identity");const player=this,e=window.decadeUI,t=e.getPlayerIdentity(this),a=e.config.newDecadeStyle,n=function(e,t,player){const a=window.decadeUIPath+"image/styles/",n={onlineUI:`online/dead4_${t}.png`,babysha:`baby/dead3_${t}.png`,codename:`codename/dead_${t}.png`,on:`decade/dead_${t}.png`,othersOff:`decade/dead_${t}.png`};if(n[e])return a+n[e];if(player!==game.me)return a+`shousha/dead2_${t}.png`;return a+"shousha/dead2_me.png"}(a,t,player),i=new Image;i.onerror=()=>{player.node.dieidentity.innerHTML=`${e.getPlayerIdentity(player,player.identity,!0)}<br>阵亡`},(player._trueMe||player)!==game.me&&player!==game.me&&"off"===a?player.node.dieidentity.innerHTML=`\n\t\t\t<div style="width:21px; height:81px; left:22.5px; top:-12px; position:absolute;\n\t\t\t\tbackground-image: url(${lib.assetURL}extension/十周年UI/image/ui/misc/likai.png);\n\t\t\t\tbackground-size: 100% 100%;">\n\t\t\t</div>\n\t\t`:player.node.dieidentity.innerHTML="",player.node.dieidentity.style.backgroundImage=`url("${n}")`,i.src=n,setTimeout(()=>{e.animation?.playSpine("effect_zhenwang",{parent:player,scale:.8})},250)}function r(e,t,a,n){"string"!=typeof t&&(t="legend"),game.addVideo("skill",this,[e,t,a,n]),game.broadcastAll((player,e,t,a,n)=>{const i=window.decadeUI;if(!i)return game.delay(2.5),void(t&&player.$fullscreenpop(t,a,n));i.delay(2500),t&&i.effect.skill(player,t,n)},this,t,e,a,n)}function c(e){this.style.animation;let t=this._cssanimations;void 0===t&&(t=[],this._cssanimations=t,this.addEventListener("animationend",function(e){if(this.style.animationName!==e.animationName)return;const t=this.style.animation,a=this._cssanimations;for(;a.length;){if(this.style.animation=a.shift(),this.style.animation!==t)return;a.current=this.style.animation}a.current="",this.style.animation=""})),t.current||t.length?t.push(e):(t.current=e,this.style.animation=e)}function l(e){if(!lib.config.card_animation_info)return null;const t={};return e.forEach(e=>{t[e.playerid]=get.cardsetion(e)}),t}function p(){const t=e().boundsCaches.arena;return t.updated||t.update(),{scale:t.cardScale,centerX:(t.width-t.cardWidth)/2,y:Math.round(.45*t.height-t.cardHeight/2)}}function h(card,e,t,a,n,i,s){const o=card.copy("thrown");if(o.classList.add("infohidden"),o.classList.remove("decade-card"),o.style.background="",o.style.transform=`translate(${t}px, ${a}px) scale(${n}) perspective(600px) rotateY(180deg)`,ui.arena.appendChild(o),ui.thrown.push(o),i?.[e.playerid]){ui.create.div(".cardsetion",i[e.playerid],o).style.setProperty("display","block","important")}return setTimeout(()=>{o.style.transition="all ease-in 0.3s",o.style.transform=`translate(${t}px, ${a}px) scale(${n}) perspective(600px) rotateY(270deg) translateX(52px)`,o.listenTransition(()=>{o.classList.remove("infohidden"),card.classList.contains("decade-card")?(o.classList.add("decade-card"),o.style.background=card.style.background):card.classList.contains("fullimage")&&(o.classList.add("fullimage"),card.style.backgroundImage?(o.style.backgroundImage=card.style.backgroundImage,o.style.backgroundSize=card.style.backgroundSize):o.style.background=card.style.background),o.style.transition="all 0s",ui.refresh(o),o.style.transform=`translate(${t}px, ${a}px) scale(${n}) perspective(600px) rotateY(-90deg) translateX(52px)`,ui.refresh(o),o.style.transition="",ui.refresh(o),o.style.transform=`translate(${t}px, ${a}px) scale(${n})`})},s),o}export{i as playerCompare,s as playerCompareMultiple,n as playerDamage,a as playerDamagepop,d as playerDieAfter,o as playerLine,c as playerQueueCssAnimation,r as playerSkill};
