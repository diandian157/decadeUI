import{game,_status,ui,lib,get}from"noname";import{applyCardBorder as t}from"../../ui/cardStyles.js";import{applyCardSkin as e,handleSkinFallback as n}from"./skin-applier.js";import{isSkinPreloaded as s,getSkinCache as r,generateSkinFilename as i,getFallbackKey as a,getFallbackSkinUrl as o}from"./skin-loader.js";import{CARD_ANIMATION as d,LAYOUT as c}from"../../constants.js";let h=null,u=null;function l(t,e){h=t,u=e}function m(){const t=u.apply(this,arguments);t.nature=this.nature;const e=lib.config.extension_十周年UI_cardPrettify;if(!e||"off"===e)return t;if(!s(e))return t;const d=r(e),c=i(t.name,t.nature),h=d[c],l=a(e);if(h&&!h.loaded&&t.classList.contains("decade-card"))void 0===h.loaded&&h.image?h.image.addEventListener("error",()=>{n(t,h,l,c)}):!1===h.loaded&&n(t,h,l,c);else if(!h&&l){const e=o(l,c);e&&(t.style.background=`url("${e}")`,t.classList.add("decade-card"))}return t}function f(card){h.apply(this,arguments),this.node.range.innerHTML="";const t=lib.card[card[2]];return t&&(this.dataset.cardName=card[2],this.dataset.cardType=t.type||"",this.dataset.cardSubtype=t.subtype||"",this.dataset.cardMultitarget=t.multitarget?"1":"0"),function(t,card){const e=Array.isArray(card[4])?[...card[4]]:[];if(!t.cardid)return;_status.cardtag=_status.cardtag||{};for(const r in _status.cardtag)_status.cardtag[r].includes(t.cardid)&&e.push(r);const n=[...new Set(e)];if(0===n.length)return;let s=' <span class="cardtag">';n.forEach(e=>{_status.cardtag[e]=_status.cardtag[e]||[],_status.cardtag[e].includes(t.cardid)||_status.cardtag[e].push(t.cardid),s+=lib.translate[e+"_tag"]}),t.node.range.innerHTML+=s+"</span>"}(this,card),function(t,card){const e=t.$vertname;t.$name.innerHTML=e.innerHTML;let n=card[1]||"";parseInt(n)==n&&(n=parseInt(n));n=get.strNumber(n,!0)||n,t.$suitnum.$num.innerHTML="string"==typeof n?n:0!==t.number&&get.strNumber(t.number)||t.number||"",t.$suitnum.$suit.innerHTML=get.translation(t.dataset.suit=t.suit);const s=t.$equip,r=s.innerHTML,i=r.indexOf(" ");s.$suitnum.innerHTML=r.slice(0,i),s.$name.innerHTML=r.slice(i);const a=t.node,o=a.background;a.judgeMark.node.judge.innerHTML=o.innerHTML,o.classList.contains("tight")&&o.classList.remove("tight");for(;a.info.firstChild;)a.info.removeChild(a.info.lastChild)}(this,card),function(t){t.style.color&&t.style.removeProperty("color");t.style.textShadow&&t.style.removeProperty("text-shadow");t.node.info.style.opacity&&t.node.info.style.removeProperty("opacity");t.$vertname.style.opacity&&t.$vertname.style.removeProperty("opacity")}(this),e(this,card),this}function p(t,e){if(e)return void setTimeout(()=>{this.updateTransform(this.classList.contains("selected"))},e);if(_status.event.player!=game.me)return;if(this._transform&&this.parentNode?.parentNode?.parentNode==ui.me&&(!_status.mousedown||_status.mouseleft))if(t){const t=window.decadeUI?.isMobile?.()?c.CARD_SELECT_OFFSET_MOBILE:c.CARD_SELECT_OFFSET_DESKTOP;this.style.transform=`${this._transform} translateY(-${t}px)`}else this.style.transform=this._transform||""}function g(player){if(!player)return;if(this.name?.startsWith("shengbei_left_")||this.name?.startsWith("shengbei_right_"))return this;const e=window.decadeUI,n=e?.boundsCaches?.arena;n?.updated||n?.update(),player.checkBoundsCache?.(),this.fixed=!0;const s=Math.round((player.cacheWidth-n.cardWidth)/2+player.cacheLeft),r=Math.round((player.cacheHeight-n.cardHeight)/2+player.cacheTop),i=n.cardScale;return this.tx=s,this.ty=r,this.scaled=!0,this.style.transform=`translate(${s}px,${r}px) scale(${i})`,player!==game.me&&t(this,player),this}function y(player){this.fixed=!0,this.name?.startsWith("shengbei_left_")||this.name?.startsWith("shengbei_right_")||this.moveTo(player),setTimeout(()=>this.delete(),d.MOVE_DELETE_DELAY)}export{m as cardCopy,f as cardInit,y as cardMoveDelete,g as cardMoveTo,p as cardUpdateTransform,l as setBaseCardMethods};
