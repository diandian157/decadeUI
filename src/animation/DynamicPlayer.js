import"noname";import{AnimationPlayer as e}from"./AnimationPlayer.js";import{observeSize as i,throttle as t}from"./utils.js";let s=0;const r=new Array(2);class a{constructor(e){this.id=s++,this.dpr=1,this.width=120,this.height=180,this.dprAdaptive=!1,this.BUILT_ID=0,this.offscreen=!1,this.offscreen||this._initMainThreadRenderer(e)}_initOffscreenRenderer(e){for(let s=0;s<r.length;s++){if(r[s]){if(r[s].capacity>=4)continue}else r[s]=new Worker(decadeUIPath+"src/animation/dynamicWorker.js"),r[s].capacity=0;this.renderer=r[s],this.canvas=document.createElement("canvas"),this.canvas.className="animation-player",i(this.canvas,t(e=>{this.height=Math.round(e.height),this.width=Math.round(e.width),this.update()},100,this));const a=this.canvas.transferControlToOffscreen();r[s].postMessage({message:"CREATE",id:this.id,canvas:a,pathPrefix:e},[a]),r[s].capacity++,this.offscreen=!0;break}}_initMainThreadRenderer(i){const s=new e(i);this.canvas=s.canvas,this.renderer=s,decadeUI.bodySensor.addListener(t(()=>{this.renderer.resized=!1},100,this),!0)}play(e){const i="string"==typeof e?{name:e}:e;if(i.id=this.BUILT_ID++,i.loop=!0,this.offscreen)this.initialized||(this.initialized=!0,this.dpr=Math.max(window.devicePixelRatio*(window.documentZoom||1),1),this.height=this.canvas.clientHeight,this.width=this.canvas.clientWidth),"function"==typeof i.oncomplete&&(i.oncomplete=i.oncomplete.toString()),this.renderer.postMessage({message:"PLAY",id:this.id,dpr:this.dpr,dprAdaptive:this.dprAdaptive,outcropMask:this.outcropMask,useMipMaps:this.useMipMaps,width:this.width,height:this.height,sprite:i});else{const e=this.renderer;e.useMipMaps=this.useMipMaps,e.dprAdaptive=this.dprAdaptive,e.outcropMask=this.outcropMask;const t=()=>{const t=e.playSpine(i);t.opacity=0,t.fadeTo(1,600)};e.hasSpine(i.name)?t():e.loadSpine(i.name,"skel",t)}return i}stop(e){this.offscreen?this.renderer.postMessage({message:"STOP",id:this.id,sprite:e}):this.renderer.stopSpine(e)}stopAll(){this.offscreen?this.renderer.postMessage({message:"STOPALL",id:this.id}):this.renderer.stopSpineAll()}update(e){if(!this.offscreen)return this.renderer.resized=!1,this.renderer.useMipMaps=this.useMipMaps,this.renderer.dprAdaptive=this.dprAdaptive,void(this.renderer.outcropMask=this.outcropMask);this.dpr=Math.max(window.devicePixelRatio*(window.documentZoom||1),1),!1!==e&&this.renderer.postMessage({message:"UPDATE",id:this.id,dpr:this.dpr,dprAdaptive:this.dprAdaptive,outcropMask:this.outcropMask,useMipMaps:this.useMipMaps,width:this.width,height:this.height})}}export{s as BUILT_ID,a as DynamicPlayer,r as DynamicWorkers};
