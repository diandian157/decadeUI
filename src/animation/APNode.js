import"noname";import{TimeStep as t}from"./TimeStep.js";import{useNewDpr as e}from"./utils.js";class i{constructor(t={}){this.id=void 0,this.name=t.name,this.skeleton=t.skeleton,this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.angle=t.angle,this.scale=t.scale,this.opacity=t.opacity,this.flipX=t.flipX,this.flipY=t.flipY,this.clip=t.clip,this.hideSlots=t.hideSlots,this.clipSlots=t.clipSlots,this.disableMask=t.disableMask,this.renderX=this.renderY=this.renderAngle=void 0,this.renderScale=this.renderOpacity=this.renderClip=void 0,this.mvp=new spine.webgl.Matrix4,this.action=t.action,this.loop=t.loop,this.loopCount=t.loopCount,this.speed=t.speed,this.completed=!0,this.onupdate=t.onupdate,this.oncomplete=t.oncomplete,this.referNode=t.referNode,this.referFollow=t.referFollow,this.referBounds=void 0,this.timestepMap={}}fadeTo(t,e){return void 0!==t&&(this.updateTimeStep("opacity",this.opacity??1,t,e),this.opacity=t),this}moveTo(t,e,i){return void 0!==t&&(this.updateTimeStep("x",this.x??[0,.5],t,i),this.x=t),void 0!==e&&(this.updateTimeStep("y",this.y??[0,.5],e,i),this.y=e),this}scaleTo(t,e){return void 0!==t&&(this.updateTimeStep("scale",this.scale??1,t,e),this.scale=t),this}rotateTo(t,e){return void 0!==t&&(this.updateTimeStep("angle",this.angle??0,t,e),this.angle=t),this}update(t){const i=(t,e,i)=>Array.isArray(t)?t[0]+t[1]*e:t,s=e?parseFloat(window.getComputedStyle(document.body).zoom):1,o=t.dpr/s,h={width:t.canvas.width,height:t.canvas.height},n=this.referNode instanceof HTMLElement?this.referNode:void 0;n&&(!this.referFollow&&this.referBounds||(this.referBounds=this._calcReferBounds(n)),h.height=this.referBounds.height*o,h.width=this.referBounds.width*o);const r=this.skeleton.bounds.size;let d,a,l,p,c;const m=this.timestepMap.x;m&&!m.completed?(m.update(t.delta),d=i(m.current,h.width)):void 0!==this.x&&(d=i(this.x,h.width));const u=this.timestepMap.y;u&&!u.completed?(u.update(t.delta),a=i(u.current,h.height)):void 0!==this.y&&(a=i(this.y,h.height)),void 0!==this.width&&(p=i(this.width,h.width)/r.x),void 0!==this.height&&(c=i(this.height,h.height)/r.y),n&&(d=void 0!==d?d+this.referBounds.x*o:(this.referBounds.x+this.referBounds.width/2)*o,a=void 0!==a?a+this.referBounds.y*o:(this.referBounds.y+this.referBounds.height/2)*o),this.mvp.ortho2d(0,0,t.canvas.width,t.canvas.height),this._applyTranslation(d,a);const f=this.timestepMap.scale;l=f&&!f.completed?(f.update(t.delta),f.current):this.scale??1,l*=p&&!c?p:!p&&c?c:p&&c?Math.min(p,c):o*s,1!==l&&this.mvp.scale(l,l,0);const g=this.timestepMap.angle;this.renderAngle=g&&!g.completed?(g.update(t.delta),g.current):this.angle,this.renderAngle&&this.mvp.rotate(this.renderAngle,0,0,1);const v=this.timestepMap.opacity;this.renderOpacity=v&&!v.completed?(v.update(t.delta),v.current):this.opacity,this.renderX=d,this.renderY=a,this.renderScale=l,this.clip&&(this.renderClip={x:i(this.clip.x,t.canvas.width),y:i(this.clip.y,t.canvas.height),width:i(this.clip.width,t.canvas.width),height:i(this.clip.height,t.canvas.height)}),this.onupdate&&this.onupdate()}_calcReferBounds(t){const i=HTMLElement.prototype.getBoundingClientRect.toString().includes("[native code]");let s=t.getBoundingClientRect();if(e)if(i){let e=1,i=t;for(;i&&i!==document.body;)e*=parseFloat(window.getComputedStyle(i).zoom),i=i.parentElement;s=new DOMRect(s.x/e,s.y/e,s.width/e,s.height/e)}else{const e=window.documentZoom||1;s=new DOMRect(s.x*e,s.y*e,s.width*e,s.height*e);let i=1,o=t;for(;o&&o!==document.body;)i*=parseFloat(window.getComputedStyle(o).zoom),o=o.parentElement;s=new DOMRect(s.x/i,s.y/i,s.width/i,s.height/i)}const o=decadeUI.get.bodySize().height*(e?window.documentZoom:1);return{x:s.left,y:o-s.bottom,width:s.width,height:s.height}}_applyTranslation(t,e){void 0!==t&&void 0===e?(this.mvp.translate(t,0,0),this.mvp.setY(0)):void 0===t&&void 0!==e?(this.mvp.translate(0,e,0),this.mvp.setX(0)):void 0!==t&&void 0!==e?this.mvp.translate(t,e,0):this.mvp.setPos2D(0,0)}setAction(t,e){if(!this.skeleton||this.skeleton.node!==this)return console.error("setAction: 节点失去关联");if(null===this.skeleton.data.findAnimation(t))return console.error("setAction: 未找到对应骨骼动作");this.skeleton.state.setAnimation(0,t,this.loop).mixDuration=void 0===e?.5:e/1e3}resetAction(t){if(!this.skeleton||this.skeleton.node!==this)return console.error("resetAction: 节点失去关联");this.skeleton.state.setAnimation(0,this.skeleton.defaultAction,this.loop).mixDuration=void 0===t?.5:t/1e3}complete(){if(this.oncomplete){if("string"==typeof this.oncomplete){const t=this.oncomplete,e=t.indexOf("{"),i=t.lastIndexOf("}");if(-1===e||-1===i)return this.oncomplete=void 0,console.error(this.name+" 的oncomplete函数语法错误");this.oncomplete=new Function(t.substring(e+1,i))}"function"==typeof this.oncomplete&&this.oncomplete()}}updateTimeStep(e,i,s,o){if(!o)return;let h=this.timestepMap[e];return h?(h.start=h.completed?i:h.current,h.end=s,h.time=h.percent=0,h.completed=!1,h.duration=o):(h=new t({start:i,end:s,duration:o}),this.timestepMap[e]=h),h}}export{i as APNode};
