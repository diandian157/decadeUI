import"noname";import{APNode as e}from"./APNode.js";class t{constructor(e,t,i){if(!window.spine)return console.error("spine 未定义."),this.spine={assets:{}},this.gl=null,void this.check();let s;"offscreen"===t?(s=i,this.offscreen=!0):(s=document.createElement("canvas"),s.className="animation-player",i&&(s.id=i),t&&t.appendChild(s));const n={alpha:!0};let o=s.getContext("webgl2",n);o?o.isWebgl2=!0:o=s.getContext("webgl",n)||s.getContext("experimental-webgl",n),o?this.spine={shader:spine.webgl.Shader.newTwoColoredTextured(o),batcher:new spine.webgl.PolygonBatcher(o),skeletonRenderer:new spine.webgl.SkeletonRenderer(o),assetManager:new spine.webgl.AssetManager(o,e),assets:{},skeletons:[]}:(this.spine={assets:{}},console.error("当前设备不支持 WebGL.")),this.gl=o,this.canvas=this.$canvas=s,this.frameTime=void 0,this.running=!1,this.resized=!1,this.dpr=1,this.nodes=[],this.BUILT_ID=0,this._dprAdaptive=!1,Object.defineProperties(this,{dprAdaptive:{get(){return this._dprAdaptive},set(e){this._dprAdaptive!==e&&(this._dprAdaptive=e,this.resized=!1)}},useMipMaps:{get(){return this.gl?.useMipMaps},set(e){this.gl&&(this.gl.useMipMaps=e)}}}),this.offscreen||(this.canvas.width=s.clientWidth,this.canvas.height=s.clientHeight),this.check()}check(){if(!this.gl){const e=()=>{};for(const t of Object.keys(this.__proto__))"function"==typeof this.__proto__[t]&&(this.__proto__[t]=e);for(const t of Object.keys(this))"function"==typeof this[t]&&"check"!==t&&(this[t]=e)}}createTextureRegion(e,t){const i=new spine.TextureAtlasPage;i.name=t,i.uWrap=i.vWrap=spine.TextureWrap.ClampToEdge,i.texture=this.spine.assetManager.textureLoader(e),i.texture.setWraps(i.uWrap,i.vWrap),i.width=i.texture.getImage().width,i.height=i.texture.getImage().height;const s=new spine.TextureAtlasRegion;return s.page=i,s.rotate=!1,s.width=s.originalWidth=i.width,s.height=s.originalHeight=i.height,s.x=s.y=0,s.u=s.v=0,s.u2=s.v2=1,s.index=-1,s.texture=i.texture,s.renderObject=s,s}hasSpine(e){return void 0!==this.spine.assets[e]}loadSpine(e,t,i,s){if(!this.spine.assetManager)return void(s&&s());const n=(t||"skel").toLowerCase(),o=this.spine.assetManager,r=this.spine.assets,a={filename:e,skelType:n,loaded:0,errors:0,toLoad:2,onerror:(t,i)=>{a.toLoad--,a.errors++,0===a.toLoad&&(console.error(`loadSpine: [${e}] 加载失败.`),s&&s())},onload:(t,o)=>{a.toLoad--,a.loaded++,0===a.toLoad&&(a.errors>0?(console.error(`loadSpine: [${e}] 加载失败.`),s&&s()):(r[e]={name:e,skelType:n},i&&i()))},ontextLoad:(t,i)=>{const s=new spine.TextureAtlasReader(i),n=this._getPathPrefix(e);let r=null;for(;;){let e=s.readLine();if(null===e)break;e=e.trim(),0===e.length?r=null:r||(r=e,a.toLoad++,o.loadTexture(n+r,a.onload,a.onerror))}a.onload(t,i)}};"json"===n?o.loadText(e+".json",a.onload,a.onerror):o.loadBinary(e+".skel",a.onload,a.onerror),o.loadText(e+".atlas",a.ontextLoad,a.onerror)}_getPathPrefix(e){const t=e.lastIndexOf("/"),i=e.lastIndexOf("\\");return-1===t&&-1===i?"":e.substring(0,Math.max(t,i)+1)}prepSpine(e,t){const i=this.spine.assets;if(!i[e])return t?(this.loadSpine(e,"skel",()=>this.prepSpine(e)),"loading"):void console.error(`prepSpine: [${e}] 骨骼没有加载`);const s=this.spine.skeletons;for(const l of s)if(l.name===e&&l.completed)return l;const n=i[e],o=this.spine.assetManager;if(!n.skelRawData){const t=this._getPathPrefix(e),i=new spine.TextureAtlas(o.get(e+".atlas"),e=>o.get(t+e)),s=new spine.AtlasAttachmentLoader(i);n.skelRawData="json"===n.skelType?new spine.SkeletonJson(s):new spine.SkeletonBinary(s),n.ready=!0}const r=n.skelRawData.readSkeletonData(o.get(`${e}.${n.skelType}`)),a=new spine.Skeleton(r);return a.name=e,a.completed=!0,a.setSkinByName("default"),a.setToSetupPose(),a.updateWorldTransform(),a.state=new spine.AnimationState(new spine.AnimationStateData(a.data)),a.state.addListener({complete(e){const t=a.node;t?(e.loop=t.loop??!1,e.loop&&t.loopCount>0&&(t.loopCount--,0===t.loopCount&&(e.loop=!1)),a.completed=t.completed=!e.loop,t.complete&&t.complete()):(a.completed=!e.loop,console.error("skeleton complete: 超出预期的错误"))}}),a.bounds={offset:new spine.Vector2,size:new spine.Vector2},a.getBounds(a.bounds.offset,a.bounds.size,[]),a.defaultAction=r.animations[0].name,a.node=void 0,s.push(a),a}playSpine(t,i){if(void 0===t)return void console.error("playSpine: parameter undefined");if("string"==typeof t&&(t={name:t}),!this.hasSpine(t.name))return void console.error(`playSpine: [${t.name}] 骨骼没有加载`);let s;if(t instanceof e&&t.skeleton.completed)s=t.skeleton;else{if(s=this.spine.skeletons.find(e=>e.name===t.name&&e.completed),s||(s=this.prepSpine(t.name)),!(t instanceof e)){const i=t;(t=new e(t)).id=i.id??this.BUILT_ID++,this.nodes.push(t)}t.skeleton=s,s.node=t}t.completed=s.completed=!1,i&&Object.assign(t,{x:i.x,y:i.y,height:i.height,width:i.width,scale:i.scale,angle:i.angle,referNode:i.parent,referFollow:i.follow});return s.state.setAnimation(0,t.action||s.defaultAction,t.loop).mixDuration=0,void 0===this.requestId&&(this.running=!0,this.offscreen||(this.canvas.style.visibility="visible"),this.requestId=requestAnimationFrame(this.render.bind(this))),t.referBounds=void 0,t}loopSpine(e,t){return"string"==typeof e?e={name:e,loop:!0}:e.loop=!0,this.playSpine(e,t)}stopSpine(e){const t=e.id??e;for(const i of this.nodes)if(i.id===t&&!i.completed)return i.completed=!0,i.skeleton.state.setEmptyAnimation(0),i;return null}stopSpineAll(){for(const e of this.nodes)e.completed||(e.completed=!0,e.skeleton.state.setEmptyAnimation(0))}getSpineActions(e){if(!this.hasSpine(e))return void console.error(`getSpineActions: [${e}] 骨骼没有加载`);let t=this.spine.skeletons.find(t=>t.name===e);return t||(t=this.prepSpine(e)),t.data.animations.map(e=>({name:e.name,duration:e.duration}))}getSpineBounds(e){if(!this.hasSpine(e))return void console.error(`getSpineBounds: [${e}] 骨骼没有加载`);if(!this.resized){const e=this.dprAdaptive?Math.max(window.devicePixelRatio*(window.documentZoom||1),1):1;this.canvas.elementHeight=this.canvas.clientHeight,this.canvas.elementWidth=this.canvas.clientWidth,this.canvas.height=this.canvas.elementHeight*e,this.canvas.width=this.canvas.elementWidth*e}let t=this.spine.skeletons.find(t=>t.name===e);return t||(t=this.prepSpine(e)),t.bounds}render(e){const t=this.canvas,i=this.offscreen,s=this.dprAdaptive?i?this.dpr||1:Math.max(window.devicePixelRatio*(window.documentZoom||1),1):1,n=e-(this.frameTime??e);this.frameTime=e;let o=!0;this.resized&&0!==t.width&&0!==t.height||(this.resized=!0,i?(this.width&&(t.width=s*this.width,o=!1),this.height&&(t.height=s*this.height,o=!1)):(t.width=s*t.clientWidth,t.height=s*t.clientHeight,o=!1));const r={dpr:s,delta:n,canvas:t,frameTime:e};for(let h=this.nodes.length-1;h>=0;h--){const e=this.nodes[h];e.completed?this.nodes.splice(h,1):e.update(r)}const a=this.gl;if(a.viewport(0,0,t.width,t.height),o&&(a.clearColor(0,0,0,0),a.clear(a.COLOR_BUFFER_BIT)),0===this.nodes.length)return this.frameTime=this.requestId=void 0,this.running=!1,void(i||(this.canvas.style.visibility="hidden"));const{shader:l,batcher:d,skeletonRenderer:p}=this.spine;a.enable(a.SCISSOR_TEST),a.scissor(0,0,t.width,t.height),this.bindShader||(this.bindShader=l,l.bind(),l.setUniformi(spine.webgl.Shader.SAMPLER,0));for(const h of this.nodes){h.renderClip&&(a.clipping=h.renderClip,a.scissor(a.clipping.x,a.clipping.y,a.clipping.width,a.clipping.height));const e=h.skeleton,i=e.state,s=h.speed??1;e.flipX=h.flipX,e.flipY=h.flipY,e.opacity=h.renderOpacity??1,i.hideSlots=h.hideSlots,i.update(n/1e3*s),i.apply(e),e.updateWorldTransform(),l.setUniform4x4f(spine.webgl.Shader.MVP_MATRIX,h.mvp.values),d.begin(l),p.premultipliedAlpha=h.premultipliedAlpha,p.outcropMask=this.outcropMask,p.outcropMask&&(p.outcropX=h.renderX,p.outcropY=h.renderY,p.outcropScale=h.renderScale,p.outcropAngle=h.renderAngle,p.clipSlots=h.clipSlots),p.hideSlots=h.hideSlots,p.disableMask=h.disableMask,p.draw(d,e),d.end(),a.clipping&&(a.clipping=void 0,a.scissor(0,0,t.width,t.height))}a.disable(a.SCISSOR_TEST),this.requestId=requestAnimationFrame(this.render.bind(this))}}export{t as AnimationPlayer};
