import{lib,get,_status,game}from"noname";import{cardEasterEggs as e}from"./easterEggs/cardEasterEggs.js";import{deathEasterEggs as t,damageEasterEggs as r,phaseStartEasterEggs as a}from"./easterEggs/eventEggs.js";import{gameStartDialogues as n}from"./easterEggs/dialogueEggs.js";const o=e,s=(player,e)=>{if("player"!==get.itemtype(player))return!1;return!!get.nameList(player).some(t=>t?.includes(e))&&((player,e)=>!player?.isUnseen||!(!player.name1?.includes(e)||player.isUnseen(0))||!(!player.name2?.includes(e)||player.isUnseen(1)))(player,e)},i=e=>game.players?.find(t=>s(t,e)),u=e=>game.playAudio("..","extension","十周年UI",`audio/caidan/${e}`),p=/* @__PURE__ */new Map,c=(e,t)=>{if(!e.sequence?.length)return null;const r=e.sequenceKey?.(t)||`${e.player}-${e.cards.join(",")}`,a=p.get(r)||0;return p.set(r,a+1),e.sequence[a%e.sequence.length]},l=(e,t,r)=>{for(const a of e){if(!t(a))continue;const e=r(a);if(!e)continue;const n=a.sequence?c(a,{}):null;return e.say?.(n?.text||a.text),(n?.audio||a.audio)&&u(n?.audio||a.audio),!0}return!1},y=/* @__PURE__ */new Set,d=()=>{for(const e of n){if(y.has(e))continue;if(e.players.every(e=>i(e))){y.add(e),e.dialogues.forEach(({player:player,text:e,audio:t,delay:r})=>{setTimeout(()=>{const r=i(player);r&&(r.say?.(e),t&&u(t))},r)});break}}},g=(e,t)=>{if(!e.cards.includes(t.cardName))return!1;if(e.player&&!s(t.player,e.player))return!1;if(""===e.player&&e.speaker&&s(t.player,e.speaker))return!1;if(e.group&&t.player?.group!==e.group)return!1;if(e.needPlayer&&!i(e.needPlayer))return!1;if(e.targetHas){const r=Array.isArray(e.targetHas)?e.targetHas:[e.targetHas],a=t.targets?.some(e=>r.some(t=>s(e,t)));if(!a)return!1}if(e.targetGroup){const r=t.targets?.some(t=>t.group===e.targetGroup);if(!r)return!1}return!(e.condition&&!e.condition(t))};function f(){const e=lib.element.Player.prototype.useCard;lib.element.Player.prototype.useCard=function(...t){const event=e.apply(this,t);if(!event?.card||!event?.player)return event;const r=((event,e)=>({card:event.card,player:event.player,targets:event.targets,cardName:e,hasName:s,findPlayer:e=>i(e)}))(event,get.name(event.card,event.player));for(const e of o){if(!g(e,r))continue;const t=e.speaker?i(e.speaker):e.target?r.targets?.find(t=>s(t,e.target)):event.player;if(t){const a=c(e,r);t.say?.(a?.text||e.text),(a?.audio||e.audio)&&u(a?.audio||e.audio);break}}return event};const n=lib.element.Player.prototype.damage;lib.element.Player.prototype.damage=function(...e){const event=n.apply(this,e);return event?.then(()=>{const e=event?.player||this;e&&l(r,t=>s(e,t.player),()=>e)}),event};const p=lib.element.Player.prototype.$die;lib.element.Player.prototype.$die=function(...e){const result=p.apply(this,e);for(const r of t){if(!s(this,r.deceased))continue;const e=i(r.speaker);if(e){e.say?.(r.text),r.audio&&u(r.audio);break}}return result};const y=lib.element.GameEvent.prototype.trigger;lib.element.GameEvent.prototype.trigger=function(e){const result=y.apply(this,arguments);return"phaseBeginStart"===e&&_status.currentPhase&&l(a,e=>s(_status.currentPhase,e.player),()=>_status.currentPhase),("chooseToCompareAfter"===e||"compare"===e&&["chooseToCompare","chooseToCompareMultiple"].includes(this.name))&&(event=>{const player=event.player,e=event.target||event.targets?.[0];if(player&&e&&event.result1===event.result2&&(s(player,"zhangfei")||s(e,"zhangfei"))){const t=s(player,"zhangfei")?player:e;t.say?.("俺也一样！"),u("zhangfei6.mp3")}})(this),"showCharacterEnd"===e&&d(),result},lib.announce.subscribe("gameStart",()=>{if(!game.players?.length)return;game.players.some(e=>e.isUnseen?.())||d()})}export{f as setupAudioHooks};
