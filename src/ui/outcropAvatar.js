import{game,lib}from"noname";const t={shizhounian:"dcloutou",shousha:"ssloutou"},n=/* @__PURE__ */new Map,e={pending:[],active:0,maxConcurrent:4,add(t){this.active<this.maxConcurrent?(this.active++,t()):this.pending.push(t)},next(){this.active--,this.pending.length>0&&this.active<this.maxConcurrent&&(this.active++,this.pending.shift()())}},r=()=>lib.config?.extension_十周年UI_outcropSkin??"off";function a(t){const n=lib.character?.[t];if(!n)return null;if(n.img){const t=n.img.match(/^extension\/([^\/]+)\//);if(t)return t[1]}if(Array.isArray(n.trashBin))for(const e of n.trashBin)if("string"==typeof e&&e.startsWith("img:")){const t=e.slice(4).match(/^extension\/([^\/]+)\//);if(t)return t[1]}return null}function o(t){if(!t)return t;const n=lib.character?.[t];if(!n)return t;if(n.img){const t=function(t){if(!t||"string"!=typeof t)return null;if(t.startsWith("character:"))return t.slice(10);const n=t.match(/image\/character\/([^\/]+)\.(jpg|png|webp|gif)$/i);return n?n[1]:null}(n.img);if(t)return t}const e=function(t){if(!Array.isArray(t))return null;for(const n of t)if("string"==typeof n&&n.startsWith("character:"))return n.slice(10);return null}(n.trashBin);return e||t}function s(n,e){if(!(e=e??r())||"off"===e||!t[e])return null;const s=o(n),i=t[e],c=a(n);return c?`${lib.assetURL}extension/${c}/image/character/${i}/${s}.jpg`:`${lib.assetURL}extension/十周年UI/image/character/${i}/${s}.jpg`}function i(t){if(n.has(t))return n.get(t);const r=new Promise(n=>{e.add(()=>{const r=new Image,a=result=>{e.next(),n(result)};r.onload=()=>a(!0),r.onerror=()=>a(!1),r.src=t})});return n.set(t,r),r}async function c(n,e,s){if(!e||!n)return!1;if("off"===(s=s??r()))return e.classList.remove("has-outcrop"),!1;const c=t[s];if(!c)return e.classList.remove("has-outcrop"),!1;const u=e.classList.contains("avatar2");if(function(t,n){const player=t?.parentElement;return!!player?.classList&&(n?player.classList.contains("unseen2_show")||player.classList.contains("unseen2"):player.classList.contains("unseen_show")||player.classList.contains("unseen"))}(e,u)){const t=`${lib.assetURL}extension/十周年UI/image/character/${c}/hidden_image.jpg`;return await i(t)?(e.style.setProperty("background-image",`url("${t}")`,"important"),e.classList.add("has-outcrop"),!0):(e.classList.remove("has-outcrop"),!1)}const f=o(n),l=[],h=a(n);h&&l.push(`${lib.assetURL}extension/${h}/image/character/${c}/${f}.jpg`),l.push(`${lib.assetURL}extension/十周年UI/image/character/${c}/${f}.jpg`);for(const t of l)if(await i(t))return e.style.backgroundImage=`url("${t}")`,e.classList.add("has-outcrop"),!0;return e.classList.remove("has-outcrop"),!1}async function u(player,t){if(!player?.node)return;t=t??r();const n=[],e=player.name1||player.name;player.node.avatar&&e&&n.push(c(e,player.node.avatar,t));const a=player.name2;player.node.avatar2&&a&&n.push(c(a,player.node.avatar2,t)),await Promise.all(n)}function f(t){t=t??r();const n=[...game.players||[],...game.dead||[]];return Promise.all(n.map(n=>u(n,t)))}function l(){n.clear()}function h(t){return new IntersectionObserver(n=>{n.forEach(n=>{n.isIntersecting&&t(n.target)})},{rootMargin:"50px"})}let p=null;function m(){return p||(p=h(t=>{const n=t._outcropCharacter;n&&(c(n,t),p.unobserve(t),delete t._outcropCharacter)})),p}function g(t,n){t&&n&&"off"!==r()&&(t._outcropCharacter=n,m().observe(t))}function d(){const t=window.decadeUI;t&&(t.updateOutcropAvatar=u,t.updateAllOutcropAvatars=f,t.clearOutcropCache=l,t.registerLazyOutcrop=g,t.applyOutcropAvatar=c),function(){if(y)return;const t=HTMLDivElement.prototype;if(y=t.setBackground,!y)return;t.setBackground=function(t,n,...e){const result=y.call(this,t,n,...e);if("character"===n&&"off"!==r()){this.classList.contains("avatar")&&this.parentElement?.classList.contains("player")&&setTimeout(()=>{c(t,this)},0)}return result}}(),function(){if(!lib.element?.Player?.prototype?.smoothAvatar)return;const t=lib.element.Player.prototype.smoothAvatar;lib.element.Player.prototype.smoothAvatar=function(n,e){const result=t.call(this,n,e);if("off"!==r()){const player=this;setTimeout(()=>{const t=n?player.name2:player.name1||player.name,e=n?player.node?.avatar2:player.node?.avatar;t&&e&&c(t,e)},150)}return result}}(),function(){if(!lib.element?.Player?.prototype?.changeSkin)return;const t=lib.element.Player.prototype.changeSkin;lib.element.Player.prototype.changeSkin=function(n,e){const result=t.call(this,n,e);if("off"!==r()&&e){const player=this;setTimeout(()=>{const t=player.name2===e?player.node?.avatar2:player.node?.avatar;t&&c(e,t)},150)}return result}}(),function(){if(!lib.element?.Player?.prototype?.$showCharacter)return;const t=lib.element.Player.prototype.$showCharacter;lib.element.Player.prototype.$showCharacter=function(n,e){const result=t.call(this,n,e);if("off"!==r()){const player=this;setTimeout(()=>{if((0===n||2===n)&&player.node?.avatar){const t=player.name1||player.name;t&&c(t,player.node.avatar)}if((1===n||2===n)&&player.node?.avatar2){const t=player.name2;t&&c(t,player.node.avatar2)}},50)}return result}}()}let y=null;export{c as applyOutcropAvatar,i as checkImageExists,l as clearOutcropCache,h as createLazyObserver,m as getLazyObserver,o as getOutcropCharacterName,s as getOutcropImagePath,r as getOutcropStyle,g as registerLazyOutcrop,d as setupOutcropAvatar,f as updateAllOutcropAvatars,u as updatePlayerOutcropAvatar};
