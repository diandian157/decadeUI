import{lib,get,game,_status,ui}from"noname";import{element as e}from"../utils/element.js";import{updatePlayerOutcropAvatar as t}from"./outcropAvatar.js";function i(i){return function(n,o){i.lib.element.player.$init.apply(this,arguments),this.doubleAvatar=void 0!==(o&&lib.character[o]);const s=lib.character[n];s&&get.is.newLayout&&(game.minskin||!get.is.newLayout()||s.isMinskin?(s.isMinskin||game.minskin)&&this.classList.add("minskin"):this.classList.remove("minskin")),this.node.name&&this.group&&(this.node.name.dataset.nature=get.groupnature(this.group)),"othersOff"===lib.config.extension_十周年UI_newDecadeStyle&&(this.checkAndAddExperienceSuffix(n),o&&this.checkAndAddExperienceSuffix(o,!0));if("random"===lib.config.extension_十周年UI_borderLevel)if(this===game.me)this.dataset.borderLevel="five";else{const e=["one","two","three","four","five"];this.dataset.borderLevel=e[Math.floor(Math.random()*e.length)]}else delete this.dataset.borderLevel;let a=decadeUI.CUR_DYNAMIC??0,d=decadeUI.MAX_DYNAMIC??(decadeUI.isMobile()?2:10)+(window.OffscreenCanvas?8:0);decadeUI.CUR_DYNAMIC=a,decadeUI.MAX_DYNAMIC=d,this.dynamic&&this.stopDynamic();if((this.dynamic||a<d)&&decadeUI.config.dynamicSkin&&null!==_status.mode){const e=decadeUI.dynamicSkin,t=this.doubleAvatar?[n,o]:[n];let i;for(let n=0;n<t.length;n++){const o=e[t[n]];if(!o)continue;const s=Object.keys(o);if(!s.length){console.error(`player.init: ${t[n]} 没有设置动皮参数`);continue}const a=o[s[0]];void 0===a.speed&&(a.speed=1),this.playDynamic({name:a.name,action:a.action,loop:!0,loopCount:-1,speed:a.speed,filpX:void 0,filpY:void 0,opacity:void 0,x:a.x,y:a.y,scale:a.scale,angle:a.angle,hideSlots:a.hideSlots,clipSlots:a.clipSlots},1===n),this.$dynamicWrap.style.backgroundImage=`url("${decadeUIPath}assets/dynamic/${a.background}")`,i||(i=!0,decadeUI.CUR_DYNAMIC++)}}if(!this.node.showCards){const player=this;player.node.showCards=e.create("handdisplays",player),player.node.showCards.hide();const t=player.getBoundingClientRect(),i=window.innerWidth||document.documentElement.clientWidth,n=player.node.showCards,o=10,s="babysha"===lib.config.extension_十周年UI_newDecadeStyle;s&&t.left<i/2||!s&&t.left>=i/2?(n.style.left="",n.style.right=player.offsetWidth+o+"px"):(n.style.left=player.offsetWidth+o+"px",n.style.right=""),n.style.top="90px",player.node.showCards.onclick=function(){const e=player.getCards("h",e=>get.is.shownCard(e)||player.isUnderControl(!0)||game.me?.hasSkillTag("viewHandcard",null,player,!0));if(e.length>0){const t=ui.create.div(".popup-container",ui.window),i=ui.create.dialog(get.translation(player)+"的手牌",e);i.static=!0,t.addEventListener("click",()=>{t.delete(),i.close(),i.delete()})}},["handcards1","handcards2"].forEach(e=>{new MutationObserver(e=>{for(const t of e)if("childList"===t.type&&(t.addedNodes.length||t.removedNodes.length)){player.decadeUI_updateShowCards();break}}).observe(player.node[e],{childList:!0})})}if(window.decadeModule?.prefixMark&&(window.decadeModule.prefixMark.showPrefixMark(n,this),o&&this.doubleAvatar&&window.decadeModule.prefixMark.showPrefixMark(o,this)),this.node.seat||(this.node.seat=e.create("seat",this)),"bingkele"===lib.config.extension_十周年UI_cardPrettify){const e=`https://q1.qlogo.cn/g?b=qq&nk=739201322&s=640&t=${Date.now()}`;"bozai"===n&&(this.node.avatar.setBackgroundImage(e),this.node.name&&(this.node.name.innerHTML="冰可乐喵")),"bozai"===o&&this.node.avatar2&&(this.node.avatar2.setBackgroundImage(e),this.node.name2&&(this.node.name2.innerHTML="冰可乐喵"))}this.decadeUI_updateShowCards();const r=lib.config.extension_十周年UI_outcropSkin;return r&&"off"!==r&&t(this,r),this}}export{i as createPlayerInit};
