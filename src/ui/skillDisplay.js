import{lib,game,get}from"noname";import{isDoubleCharacterMode as e}from"./characterBackground.js";function t(){const t=/* @__PURE__ */new WeakMap,n=()=>game.players.length+(game.dead?.length||0),i=(e,player)=>{if(!player||player===game.me||!lib.translate?.[e])return!1;const t=get.info(e);return!t?.charlotte&&(!(!t?.zhuSkill||player.isZhu)||(!t||!t.nopop||e.startsWith("olhedao_tianshu_")))},l=e=>lib.translate?.[e]||e,r=player=>{if(n()>5)return;const i=player.node?.avatar;if(!i)return;i.parentNode.querySelectorAll(".baby_skill").forEach(e=>e.remove());const r=t.get(player)||[],a=/* @__PURE__ */new Set,o=r.filter(e=>{const t=l(e);return!a.has(t)&&(a.add(t),!0)}),s=i.getBoundingClientRect().left<window.innerWidth/2,c=e(),d=c?135:75,p=document.createDocumentFragment();o.forEach((e,t)=>{const n=document.createElement("div");n.className="baby_skill",Object.assign(n.style,{position:"absolute",bottom:35*t+30+"px",zIndex:"102",left:s?`${i.offsetWidth+(c?65:10)}px`:"",right:s?"":`${i.offsetWidth+d}px`});const r=document.createElement("div");r.className="baby_skill_box",r.dataset.skill=e,r.textContent=l(e).slice(0,2),r.style.cursor="pointer",r.addEventListener("click",t=>{var n;t.stopPropagation(),n="BtnSure",game.playAudio("..","extension","十周年UI",`audio/${n}`),((e,t)=>{if(document.querySelector(".baby_skill_popup")?.remove(),!lib.skill[e])return;const n=document.createElement("div");n.className="baby_skill_popup",n.innerHTML=`\n\t\t\t<div class="skill_title">${l(e)}</div>\n\t\t\t<div class="skill_description">${get.translation(e,"info")||"暂无描述"}</div>\n\t\t`,document.body.appendChild(n);const i=n.querySelector(".skill_title"),r=n.querySelector(".skill_description");n.style.height=`${i.scrollHeight+r.scrollHeight+32}px`;const a=t.getBoundingClientRect(),o=n.getBoundingClientRect();let s=a.left+a.width/2-o.width/2,c=a.top-o.height-10;s=Math.max(10,Math.min(s,window.innerWidth-o.width-10)),c<10&&(c=a.bottom+10),n.style.left=`${s}px`,n.style.top=`${c}px`;const d=e=>{n.contains(e.target)||(n.remove(),document.removeEventListener("click",d))};setTimeout(()=>document.addEventListener("click",d),100)})(e,t.target)}),n.appendChild(r);const a=((e,player)=>{const t=get.info(e);if(!t)return null;if(t.limited)return"xiandingjihs.png";if(t.juexingji)return"juexingjihs.png";if(get.is.zhuanhuanji(e,player)){const t=player?.node?.xSkillMarks?.querySelector(`.skillMarkItem.zhuanhuanji[data-id="${e}"]`);return t?.classList.contains("yin")?"mark_yinghs.png":"mark_yanghs.png"}return null})(e,player);if(a){const e=document.createElement("img");e.src=`extension/十周年UI/ui/assets/skill/baby/${a}`,Object.assign(e.style,{position:"absolute",top:"3px",right:"-15px",width:"16px",height:"16px",zIndex:"103"}),n.appendChild(e)}p.appendChild(n)}),i.parentNode.appendChild(p)},a=(player,e,l=!0)=>{if(n()>5||!i(e,player))return;t.has(player)||t.set(player,[]);const a=t.get(player),o=a.indexOf(e);l&&-1===o?a.push(e):!l&&o>-1&&a.splice(o,1),r(player)},o=player=>{if(n()>5||!player?.node?.avatar)return;const e=[...player.skills||[],...player.additionalSkills?Object.keys(player.additionalSkills):[]];t.set(player,e.filter(e=>i(e,player))),r(player)};["showCharacterEnd","hideCharacter","changeCharacter","removeCharacter"].forEach(event=>{const e=lib.element.player[event];"function"==typeof e&&(lib.element.player[event]=function(...t){e.apply(this,t),o(this)})});const s=lib.element.player.addSkill,c=lib.element.player.removeSkill;lib.element.player.addSkill=function(e,...t){const n=s.apply(this,[e,...t]);return(Array.isArray(e)?e:[e]).forEach(e=>requestAnimationFrame(()=>a(this,e,!0))),n},lib.element.player.removeSkill=function(e,...t){const n=c.apply(this,[e,...t]);return(Array.isArray(e)?e:[e]).forEach(e=>requestAnimationFrame(()=>a(this,e,!1))),n};const d=lib.element.player.isUnderControl;"function"==typeof d&&(lib.element.player.isUnderControl=function(...e){const result=d.apply(this,e),t=this.__babyshaUnderControl;return this.__babyshaUnderControl=result,void 0!==t&&t!==result&&n()<=5&&requestAnimationFrame(()=>o(this)),result}),lib.skill._zhuanhuanjiUpdate={charlotte:!0,forced:!0,popup:!1,silent:!0,trigger:{global:"changeZhuanhuanji"},filter:event=>n()<=5&&event.player&&event.skill,async content(event){r(event.player)}},lib.refreshPlayerSkills=o}function n(){for(const player of[...game.players,...game.dead||[]])player.node?.avatar?.parentNode?.querySelectorAll(".baby_skill").forEach(e=>e.remove())}function i(){"babysha"===lib.config.extension_十周年UI_newDecadeStyle&&game.players.length<=5&&t(),lib.clearAllSkillDisplay=n}export{n as clearAllSkillDisplay,t as initSkillDisplay,i as setupSkillDisplay};
