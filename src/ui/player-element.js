import{ui,lib,get,game,_status}from"noname";import{element as e}from"../utils/element.js";class t{constructor(e){this.dom=e,this._cache=null;new MutationObserver(()=>this._cache=null).observe(e,{childList:!0})}get childNodes(){return this._cache||(this._cache=Array.from(this.dom.childNodes)),this._cache}}function i(i,a){const player=ui.create.div(".player",i),n={node:{avatar:ui.create.div(".primary-avatar",player,ui.click.avatar).hide(),avatar2:ui.create.div(".deputy-avatar",player,ui.click.avatar2).hide(),turnedover:e.create("turned-over",player),framebg:ui.create.div(".framebg",player),intro:ui.create.div(".intro",player),identity:ui.create.div(".identity",player),hp:ui.create.div(".hp",player),long:ui.create.div(".long",player),wei:ui.create.div(".wei",player),name:ui.create.div(".name",player),name2:ui.create.div(".name.name2",player),nameol:ui.create.div(".nameol",player),count:ui.create.div(".card-count",player),equips:ui.create.div(".equips",player).hide(),judges:ui.create.div(".judges",player),marks:e.create("dui-marks",player),chain:e.create("chain",player),handcards1:ui.create.div(".handcards"),handcards2:ui.create.div(".handcards"),expansions:ui.create.div(".expansions")},phaseNumber:0,invisibleSkills:[],skipList:[],skills:[],initedSkills:[],additionalSkills:{},disabledSkills:{},hiddenSkills:[],awakenedSkills:[],forbiddenSkills:{},popups:[],damagepopups:[],judging:[],extraEquip:[],stat:[{card:{},skill:{},triggerSkill:{}}],actionHistory:[{useCard:[],respond:[],skipped:[],lose:[],gain:[],sourceDamage:[],damage:[],custom:[],useSkill:[]}],tempSkills:{},storage:{counttrigger:new Proxy({},{get:(e,t)=>player.getStat("triggerSkill")[t],set:(e,t,i)=>(player.getStat("triggerSkill")[t]=i,!0),deleteProperty:(e,t)=>(delete player.getStat("triggerSkill")[t],!0),has:(e,t)=>t in player.getStat("triggerSkill"),ownKeys:()=>Reflect.ownKeys(player.getStat("triggerSkill")),getOwnPropertyDescriptor:(e,t)=>Object.getOwnPropertyDescriptor(player.getStat("triggerSkill"),t)})},marks:{},expandedSlots:{},disabledSlots:{},ai:{friend:[],enemy:[],neutral:[],handcards:{global:[],source:[],viewed:[]}},queueCount:0,outCount:0,vcardsMap:{handcards:[],equips:[],judges:[]}},s=new Image;s.onerror=function(){const t=e.create("chain-back",player.node.chain);for(let i=0;i<40;i++)e.create("cardbg",t).style.transform=`translateX(${5*i-5}px)`;s.onerror=void 0},s.src=decadeUIPath+"image/ui/chain/tie_suo.png";const r={$cardCount:n.node.count,$dynamicWrap:e.create("dynamic-wrap")};n.node.handcards1._childNodesWatcher=new t(n.node.handcards1),n.node.handcards2._childNodesWatcher=new t(n.node.handcards2),decadeUI.get.extend(player,r),decadeUI.get.extend(player,n),Object.setPrototypeOf(player,lib.element.Player.prototype),player.node.action=ui.create.div(".action",player.node.avatar);const o=ui.create.div(player.node.identity);o.player=player,function(e,player){Object.defineProperties(e,{innerHTML:{configurable:!0,get(){return this.innerText},set(e){if("guozhan"===get.mode()||"jiange"===_status.mode||"siguo"===_status.mode)return this.style.display="none",this.innerText=e,void this.parentNode.classList.add("guozhan-mode");if("codename"===lib.config.extension_十周年UI_newDecadeStyle&&"猜"===e)return this.innerText="",this.style.visibility="",void(this.parentNode.style.backgroundImage="");const t=this.parentNode.dataset.color,i={"猜":()=>{let e="cai";return"purple"===_status.mode&&"cai"===t&&(e+="_blue"),e},"友":()=>"friend","敌":()=>"enemy","反":()=>"doudizhu"===get.mode()?"nongmin":"fan","主":()=>{let e="zhu";return"versus"===get.mode()&&"wei"===get.translation(player.side+"Color")?(e+="_blue",player.classList.add("opposite-camp")):"doudizhu"===get.mode()&&(e="dizhu"),e},"忠":()=>"identity"===get.mode()&&"purple"===_status.mode?"qianfeng":"versus"===get.mode()&&"wei"===get.translation(player.side+"Color")?(player.classList.add("opposite-camp"),"zhong_blue"):"zhong","内":()=>"purple"===_status.mode?"rNei"===t?"xizuo":"xizuo_blue":"nei","野":()=>"ye","首":()=>"zeishou","帅":()=>"zhushuai","将":()=>"three"===_status.mode||"wei"===get.translation(player.side+"Color")?"zhushuai_blue":"dajiang","兵":()=>!1===player.side?"qianfeng_blue":"qianfeng","卒":()=>!1===player.side?"qianfeng_blue":"qianfeng","师":()=>"junshi","盟":()=>"mengjun","神":()=>"boss","从":()=>"suicong","先":()=>"xianshou","后":()=>"houshou","民":()=>"commoner"}[e];if(!i)return this.innerText=e,this.style.visibility="",void(this.parentNode.style.backgroundImage="");let a=i();["cai_blue","nongmin","dizhu","zhong_blue","xizuo","xizuo_blue","zhushuai_blue","qianfeng_blue","qianfeng"].includes(a)||"b"!==this.parentNode.dataset.color?.[0]||(a+="_blue",player.classList.add("opposite-camp")),this.innerText=e,this.style.visibility="hidden";const n=lib.config.extension_十周年UI_newDecadeStyle,s=decadeUIPath+({onlineUI:"image/styles/online/identity2_",babysha:"image/styles/baby/identity3_",on:"image/styles/decade/identity_",othersOff:"image/styles/decade/identity_",codename:"image/styles/codename/identity5_"}[n]||"image/styles/shousha/identity2_")+a+".png",r=new Image;r.node=this,r.onerror=function(){this.node.style.visibility=""},r.src=s,this.parentNode.style.backgroundImage=`url("${s}")`}}})}(o,player),Object.defineProperties(player.node.count,{innerHTML:{configurable:!0,get(){return this.textContent},set(e){this.textContent!==e&&(this.textContent=e,this.dataset.text=e)}}});new MutationObserver(e=>{for(const t of e)if("childList"===t.type){(Array.from(t.addedNodes).some(e=>!e.classList?.contains("emptyequip"))||Array.from(t.removedNodes).some(e=>!e.classList?.contains("emptyequip")))&&player.$handleEquipChange()}}).observe(n.node.equips,{childList:!0}),a?player.noclick=!0:(player.addEventListener(lib.config.touchscreen?"touchend":"click",ui.click.target),player.node.identity.addEventListener(lib.config.touchscreen?"touchend":"click",ui.click.identity),lib.config.touchscreen&&(player.addEventListener("touchstart",ui.click.playertouchstart),player.addEventListener("touchmove",ui.click.playertouchmove)));const d=e.create("camp-wrap"),l=e.create("hp-wrap");player.insertBefore(d,player.node.name),player.insertBefore(l,player.node.hp),player.node.campWrap=d,player.node.hpWrap=l,l.appendChild(player.node.hp);const c={node:{back:e.create("camp-back",d),border:e.create("camp-border",d),campName:e.create("camp-name",d),avatarName:player.node.name,avatarDefaultName:e.create("avatar-name-default",d)}};decadeUI.get.extend(d,c),d.appendChild(player.node.name),d.node.avatarName.className="avatar-name",d.node.avatarDefaultName.innerHTML="guozhan"===get.mode()?"主将":"隐匿";const u={mask:player.insertBefore(e.create("mask"),player.node.identity),gainSkill:e.create("gain-skill",player)};return u.gainSkill.player=player,u.gainSkill.skills=[],u.gainSkill.gain=function(e){if(!this.skills.includes(e)&&lib.translate[e]){if("off"===lib.config.extension_十周年UI_newDecadeStyle&&"off"!==lib.config.extension_十周年UI_gainSkillsVisible){const t=lib.skill[e];if(!t||t.charlotte||t.sub||t.mark&&!t.limited||t.nopop||!1===t.popup||t.equipSkill)return;if(t.onremove&&game.me!==this.player.storage[e])return;if("othersOn"===lib.config.extension_十周年UI_gainSkillsVisible&&this.player===game.me)return;t.intro||(t.intro={content:()=>get.skillInfoTranslation(e,this.player,!1)}),this.player.markSkill(e)}this.skills.push(e),this.innerHTML=this.skills.map(e=>lib.translate[e]).join(" ")}},u.gainSkill.lose=function(e){const t=this.skills.indexOf(e);t>=0&&(this.skills.splice(t,1),this.innerHTML=this.skills.map(e=>lib.translate[e]).join(" "))},decadeUI.get.extend(player.node,u),player}export{i as createPlayerElement};
