import{ui,lib,get}from"noname";class t{constructor(){this.tooltip=null,this.currentButton=null,this.hideTimeout=null}createTooltip(){return this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.className="skill-button-tooltip",this.tooltip.style.cssText="\n\t\t\tposition: absolute;\n\t\t\tbackground: rgba(0, 0, 0, 0.9);\n\t\t\tcolor: white;\n\t\t\tpadding: 10px 15px;\n\t\t\tborder-radius: 4px;\n\t\t\tborder: 1px solid white;\n\t\t\tfont-family: yuanli, sans-serif;\n\t\t\tfont-size: 14px;\n\t\t\tline-height: 1.6;\n\t\t\tmax-width: 300px;\n\t\t\tword-wrap: break-word;\n\t\t\tz-index: 99999;\n\t\t\tpointer-events: none;\n\t\t\topacity: 0;\n\t\t\ttransition: opacity 0.2s ease;\n\t\t\tbox-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);\n\t\t",ui.arena.appendChild(this.tooltip)),this.tooltip}getElementPosition(t){let e=0,i=0,r=t;for(;r&&r!==ui.arena&&r!==document.body;)e+=r.offsetLeft||0,i+=r.offsetTop||0,r=r.offsetParent;return{left:e,top:i,width:t.offsetWidth||0,height:t.offsetHeight||0}}getSkillDescription(t,player){try{if(player&&lib.dynamicTranslate&&lib.dynamicTranslate[t]){const e=lib.dynamicTranslate[t](player,t);if("string"==typeof e&&e)return e}}catch(e){}return get.translation(t,"info")||""}formatSkillDescription(t){if(!t)return"";const{text:e,brackets:i}=this.protectBrackets(t);return t=e,t=this.addLineBreaksBeforeNumbers(t),t=this.addLineBreakAfterLastNumber(t),t=this.addLineBreaksBeforeRegularNumbers(t),t=this.addLineBreakAfterLastRegularNumber(t),t=this.addLineBreaksBeforeYinYang(t),t=this.addLineBreakAfterLastYinYang(t),t=this.restoreBrackets(t,i),t=this.highlightSkillTags(t)}highlightSkillTags(t){return["锁定技","限定技","觉醒技","转换技","主公技","主将技","副将技","阵法技","使命技"].forEach(e=>{t=t.replace(new RegExp(e,"g"),`<span style="color: #ff4444;">${e}</span>`)}),t}protectBrackets(t){const e=[];let i=t.replace(/〖[^〗]*〗/g,t=>{const i=e.length;return e.push(t),`__BRACKET_${i}__`});return i=i.replace(/（[^）]*）/g,t=>{const i=e.length;return e.push(t),`__BRACKET_${i}__`}),{text:i,brackets:e}}restoreBrackets(t,e){let i=0;for(;/__BRACKET_\d+__/.test(t)&&i<10;)t=t.replace(/__BRACKET_(\d+)__/g,(t,i)=>e[parseInt(i)]||t),i++;return t}addLineBreaksBeforeNumbers(t){return t.replace(/(\S)([①②③④⑤⑥⑦⑧⑨⑩])/g,"$1<br>$2")}addLineBreakAfterLastNumber(t){return t.replace(/([①②③④⑤⑥⑦⑧⑨⑩])(?![\s\S]*[①②③④⑤⑥⑦⑧⑨⑩])([^。]*?。)/g,"$1$2<br>")}addLineBreaksBeforeRegularNumbers(t){return t.replace(/(\S)(\d+[、.])/g,"$1<br>$2")}addLineBreakAfterLastRegularNumber(t){return t.replace(/(\d+[、.])(?![\s\S]*\d+[、.])([^。]*?。)/g,"$1$2<br>")}addLineBreaksBeforeYinYang(t){return t.replace(/([^①②③④⑤⑥⑦⑧⑨⑩\s])([阳阴]：)/g,"$1<br>$2")}addLineBreakAfterLastYinYang(t){const e=t.match(/([阳阴]：)(?![\s\S]*[阳阴]：)/);if(!e)return t;const i=e.index+e[0].length,r=t.substring(i),o=/[①②③④⑤⑥⑦⑧⑨⑩]/.test(r),s=/[⒈⒉⒊⒋⒌⒍⒎⒏⒐⒑]/.test(r),n=/\d+[、.]/.test(r);return o||s||n?t:t.replace(/([阳阴]：)(?![\s\S]*[阳阴]：)([^。；]*?[。；])/,"$1$2<br>")}show(t,e,player){if(!t||!e)return;clearTimeout(this.hideTimeout),this.currentButton=t;const i=this.createTooltip(),r=this.getSkillDescription(e,player),o=this.formatSkillDescription(r),s=lib.translate[e]||get.translation(e)||e;i.innerHTML=`<strong style="font-size: 20px;">${s}</strong><br>${o}`,i.style.opacity="0",i.style.display="block",i.style.left="-9999px",i.style.top="-9999px",requestAnimationFrame(()=>{this.positionTooltip(i,t)})}positionTooltip(t,e){const i=this.getElementPosition(e),r=t.offsetWidth,o=t.offsetHeight;let s=i.left+i.width/2-r/2;const n=ui.arena.offsetWidth;s<10?s=10:s+r>n-10&&(s=n-r-10);const a=i.top-o-10;t.style.left=`${s}px`,t.style.top=`${a}px`,t.style.opacity="1"}hide(){this.tooltip&&(this.tooltip.style.opacity="0",this.currentButton=null,this.hideTimeout=setTimeout(()=>{this.tooltip&&"0"===this.tooltip.style.opacity&&(this.tooltip.style.left="-9999px",this.tooltip.style.display="none")},200))}attach(t,e,player){if(!t||!e)return;if("ios"===lib.device||"android"===lib.device)return;if("true"===t.dataset.tooltipAttached)return;const i=this;t.addEventListener("mouseenter",function(){i.show(t,e,player)}),t.addEventListener("mouseleave",function(){i.hide()}),t.dataset.tooltipAttached="true"}destroy(){this.tooltip&&this.tooltip.parentNode&&this.tooltip.parentNode.removeChild(this.tooltip),this.tooltip=null,this.currentButton=null,clearTimeout(this.hideTimeout)}}const e=new t;export{t as SkillButtonTooltip,e as skillButtonTooltip};
