import{lib,game,get,ui,_status}from"noname";function e(card,player){if(player=player||get.owner(card),player?.canRecast)return player.canRecast(card,null,!0);const e=card.name;if(!e)return!1;const n=lib.card[e];if(!n)return!1;const t=n.recastable||n.chongzhu;return"function"==typeof t?!!t(_status.event,player):!!t}function n(card,player){return!(!card||!player)&&("h"===get.position(card)&&(!card.classList?.contains("glows")&&(!1!==card.isCard&&"cards"!==get.itemtype(card))))}function t(card,player){if(!1===lib.config.extension_十周年UI_enableRecastInteraction)return!1;if(player?.hasSkill?.("sangu_viewas"))return!1;const event=_status.event;if(event?._backup){const e=event._backup.skill||event.skill;if(e){const n=lib.skill[e];if(n?.viewAs||n?.viewAsFilter)return!1}}return!!e(card,player)&&!!n(card,player)}function r(card,player){if(!player)return!1;const e=get.info(card);if(e?.enable){if(!1===("function"==typeof e.enable?e.enable(card,player):e.enable))return!0}const n=lib.skill._decadeUI_recastable_enable,t=n?.mod;n&&(n.mod={});let r=!1;try{!1===game.checkMod(card,player,_status.event,"unchanged","cardEnabled",player)&&(r=!0),r||"card"!==get.itemtype(card)||!1===game.checkMod(card,player,_status.event,"unchanged","cardEnabled2",player)&&(r=!0)}finally{n&&t&&(n.mod=t)}return r}function i(card){const e=get.info(card);if(!e)return 1;if("equip"===e.type)return 1;const n=e.selectTarget;if(-1===n)return 1;if(Array.isArray(n))return n[0];if("number"==typeof n)return n;if("function"==typeof n)try{const result=n(card,_status.event?.player);if(-1===result)return 1;if(Array.isArray(result))return result[0];if("number"==typeof result)return result}catch(t){}return 1}const c={_decadeUI_recastable_recast:{trigger:{player:"useCardBefore"},forced:!0,popup:!1,silent:!0,priority:1/0,filter(event,player){if("off"===lib.config.extension_十周年UI_newDecadeStyle)return!1;if(event.targets&&event.targets.length>0)return!1;if(event.skill){const e=lib.skill[event.skill];if(e?.viewAs||e?.viewAsFilter)return!1}const e=event.cards?.slice()||[];if(0===e.length)return!1;const n=get.owner(e[0]);if(!n)return!1;if(player!==n)return!1;for(const card of e)if(!t(card,n))return!1;return!0},async content(event,trigger,player){trigger.cancel(),trigger.untrigger();const e=trigger.cards.slice();await player.recast(e)}}},s={_decadeUI_recastable_enable:{mod:{cardEnabled(card,player){if(player?.isPhaseUsing?.()&&t(card,player))return!0},selectTarget(card,player,e){if(!player?.isPhaseUsing?.())return;const n=ui.selected.cards?.[0];if(n&&t(n,player)&&Array.isArray(e)&&e.length>=2&&(e[0]=0,e[1]<=-1)){const t=get.info(n);e[1]="equip"===t?.type?1:game.players?.length||8}},playerEnabled(card,player,e){const n=ui.selected.cards?.[0];if(n&&t(n,player))return!r(n,player)&&void 0}}}};function a(){if(lib.skill._recasting){const n=lib.skill._recasting.filterCard;lib.skill._recasting.filterCard=function(card,player){return!e(card,player)&&n.call(this,card,player)}}lib.hooks?.checkEnd&&lib.hooks.checkEnd.add("_decadeUI_recastable_check",event=>{if(!ui.confirm)return;const card=get.card();if(!card)return;const e=ui.confirm.firstChild;if(!e||"ok"!==e.link)return;const n=ui.selected.cards?.[0],player=event?.player;if(n&&player&&t(n,player)&&"chooseToUse"===event?.name)if(0===ui.selected.targets.length)e.innerHTML="重铸",e.classList.remove("disabled");else{const n=i(card);e.innerHTML="确定",ui.selected.targets.length>=n?e.classList.remove("disabled"):e.classList.add("disabled")}}),lib.hooks?.uncheckEnd&&lib.hooks.uncheckEnd.add("_decadeUI_recastable_confirm_reset",()=>{if(!ui.confirm)return;const e=ui.confirm.firstChild;"重铸"===e?.innerHTML&&(e.innerHTML="确定")})}function o(){if(!1!==lib.config.extension_十周年UI_enableRecastInteraction&&"off"!==lib.config.extension_十周年UI_newDecadeStyle){for(const e of Object.keys(c))lib.skill[e]=c[e],game.addGlobalSkill(e);Object.assign(lib.skill,s),game.addGlobalSkill("_decadeUI_recastable_enable"),a(),function(){const e=["lulitongxin"];for(const n of e){const e=lib.card[n];if(!e?.changeTarget)continue;const t=e.changeTarget;e.changeTarget=function(player,e){if(e[0])return t.call(this,player,e)}}}()}}export{t as canRecastCard,i as getCardMinTarget,o as initRecast,r as isCardDisabledForUse,n as isRealHandCard,e as isRecastableCard,c as recastAnimateSkill,s as recastBaseSkill,a as setupRecastableCards};
