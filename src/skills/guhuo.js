import{get,ui,game,_status}from"noname";const a={guhuo_guess:{async content(event,trigger,player){player.addTempSkill("guhuo_phase"),event.fake=!1,event.betrayer=null;const[card]=trigger.cards,a=card.name!==trigger.card.name||"sha"===card.name&&!get.is.sameNature(trigger.card,card);event.fake=a,player.popup(trigger.card.name,"metal");const e=player.lose(card,ui.ordering);e.relatedEvent=trigger,await e,trigger.throw=!1,trigger.skill="xinfu_guhuo_backup";const t="useCard"===trigger.name?"使用":"打出",r=trigger.targets?.length?`对${get.translation(trigger.targets)}`:"",s=(get.translation(trigger.card.nature)||"")+get.translation(trigger.card.name);game.log(player,"声明",r,t,trigger.card),event.prompt=`${get.translation(player)}声明${r}${t}${s}，是否质疑？`,event.targets=game.filterPlayer(a=>a!==player&&!a.hasSkill("chanyuan")).sortBySeat(_status.currentPhase),game.broadcastAll((a,e)=>{const t=decadeUI.boundsCaches.arena;t.updated||t.update();const r=t.cardScale,s=Math.round((t.width-t.cardWidth)/2),n=Math.round(.45*t.height-t.cardHeight/2),o=_status.event.guhuoNode=a.copy("thrown");o.classList.add("infohidden"),o.classList.remove("decade-card"),o.style.background="",o.style.transform=`translate(${s}px, ${n}px) scale(${r}) perspective(600px) rotateY(180deg)`,ui.arena.appendChild(o),ui.thrown.push(o);ui.create.div(".cardsetion",get.cardsetion(e),o).style.setProperty("display","block","important")},card,player);for(const n of event.targets){if("reguhuo_betray"===(await n.chooseButton([event.prompt,[["reguhuo_ally","reguhuo_betray"],"vcard"]],!0).set("ai",a=>{const e=_status.event.player,t=_status.event.getParent("guhuo_guess"),r=t?.getTrigger();if(!t)return Math.random();const s={name:r.card.name,nature:r.card.nature,isCard:!0},n="reguhuo_ally"===a.link[2];if(n&&(e.hp<=1||get.attitude(e,t.player)>=0))return 1.1;if(!n&&get.attitude(e,t.player)<0&&"useCard"===r.name){const a=r.targets||[];let n=0;for(const r of a){const a=r===t.player;n+=get.effect(r,s,t.player,e)/(a?1.5:1)}return n/=1.5*a.length||1,n>0?0:n<-7?Math.random()+Math.pow(-(n+7)/8,2):Math.pow((get.value(s,t.player,"raw")-4)/(0===n?5:10),2)}return Math.random()}).forResult()).links[0][2]){n.addExpose(.2),game.log(n,"#y质疑"),n.popup("质疑！","fire"),event.betrayer=n;break}game.log(n,"#g不质疑"),n.popup("不质疑","wood"),await game.delayx()}game.broadcastAll(a=>{const e=decadeUI.boundsCaches.arena;e.updated||e.update();const t=e.cardScale,r=Math.round((e.width-e.cardWidth)/2),s=Math.round(.45*e.height-e.cardHeight/2);a.style.transition="all ease-in 0.3s",a.style.transform=`translate(${r}px, ${s}px) scale(${t}) perspective(600px) rotateY(270deg) translateX(52px)`,a.listenTransition(()=>{a.classList.remove("infohidden"),card.classList.contains("decade-card")&&(a.classList.add("decade-card"),a.style.background=card.style.background),a.style.transition="all 0s",ui.refresh(a),a.style.transform=`translate(${r}px, ${s}px) scale(${t}) perspective(600px) rotateY(-90deg) translateX(52px)`,ui.refresh(a),a.style.transition="",ui.refresh(a),a.style.transform=`translate(${r}px, ${s}px) scale(${t})`})},event.guhuoNode),await game.delay(2),event.betrayer&&(event.fake?(event.betrayer.popup("质疑正确","wood"),game.log(player,"声明的",trigger.card,"作废了"),trigger.cancel(),trigger.getParent().goto(0),trigger.line=!1):(event.betrayer.popup("质疑错误","fire"),await event.betrayer.addSkills("chanyuan")),await game.delay(2),event.fake&&game.broadcastAll(()=>ui.clear()))}}};export{a as guhuoSkill};
