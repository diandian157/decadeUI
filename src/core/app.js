import{lib,get,game,ui,ai,_status}from"noname";function initApp(){const ensureListenersArray=(e,t)=>{e[t]||(e[t]=[])};window.app={each(e,t,n){if(!e)return n;if("number"==typeof e.length)for(let i=0;i<e.length&&!1!==t.call(n,e[i],i);i++);else for(const i in e)if(!1===t.call(n,e[i],i))break;return n},isFunction:e=>"function"==typeof e,event:{listens:{},on(e,t,n){return ensureListenersArray(this.listens,e),this.listens[e].push({listen:t,remove:n}),this},off(e,t){return app.each(this.listens[e],(n,i)=>{t!==n&&t!==n.listen||this.listens[e].splice(i,1)},this)},emit(e,...t){return app.each(this.listens[e],n=>{n.listen(...t),n.remove&&this.off(e,n)},this)},once(e,t){return this.on(e,t,!0)}},create:{},listens:{},plugins:[],pluginsMap:{},path:{ext:(e,t)=>`${lib.assetURL}extension/${t||app.name}/${e}`},on(event,e){ensureListenersArray(this.listens,event),this.listens[event].push(e)},once(event,e){ensureListenersArray(this.listens,event),this.listens[event].push({listen:e,remove:!0})},off(event,e){const t=this.listens[event]||[];(e?t.filter(t=>t===e||t.listen===e):t.slice()).forEach(e=>{const n=t.indexOf(e);n>-1&&t.splice(n,1)})},emit(event,...e){(this.listens[event]||[]).forEach(t=>{if("function"==typeof t)t(...e);else if("function"==typeof t.listen&&(t.listen(...e),t.remove)){const e=this.listens[event].indexOf(t);e>-1&&this.listens[event].splice(e,1)}})},import(e){const t=e(lib,game,ui,get,ai,_status,app);t&&(t.name&&(this.pluginsMap[t.name]=t),!t.precontent||t.filter&&!t.filter()||t.precontent()),this.plugins.push(t)},importPlugin(e,t){if(!window.JSZip)return void lib.init.js(`${lib.assetURL}game`,"jszip",()=>app.importPlugin(e,t));t="function"==typeof t?t:()=>{};const n=new JSZip(e),i=[],s=[];for(const c in n.files)if(/\/$/.test(c))i.push(`extension/${app.name}/${c}`);else if(!/^extension\.(js|css)$/.test(c)){const e=c.split("/");e.pop(),s.push({id:c,path:`extension/${app.name}/${e.join("/")}`,name:e[e.length-1]||c.split("/").pop(),target:n.files[c]})}const a=i.length+s.length;let r=0;const l=lib.node?.fs,o=()=>{const e=s.shift();if(e){t(`正在导入(${++r}/${a})...`);const n=l?e.target.asNodeBuffer():e.target.asArrayBuffer();game.writeFile(n,e.path,e.name,o)}else alert("导入完成"),t("导入插件")},p=()=>{i.length?(t(`正在导入(${++r}/${a})...`),game.ensureDirectory(i.shift(),p)):o()};p()},loadPlugins(callback){game.getFileList(`extension/${app.name}`,folders=>{const total=folders.length;let current=0;if(0===total)return void callback();const loaded=()=>{++current===total&&callback()},readAndEval=(dir,file)=>{game.readFile(`extension/${app.name}/${dir}/${file}`,data=>{const binary=new Uint8Array(data),blob=new Blob([binary]),reader=new FileReader;reader.readAsText(blob),reader.onload=()=>{eval(reader.result),loaded()}},()=>loaded())},styleFileMap={on:"main1.js",othersOff:"main3.js"},fileName=styleFileMap[lib.config.extension_十周年UI_newDecadeStyle]??"main2.js";folders.forEach(e=>readAndEval(e,fileName))})},reWriteFunction(target,name,replace,str){if(name&&"object"==typeof name)return app.each(name,(e,t)=>app.reWriteFunction(target,t,e[0],e[1]),target);if(("string"==typeof replace||replace instanceof RegExp)&&("string"==typeof str||str instanceof RegExp))eval(`target.${name} = ${target[name].toString().replace(replace,str)}`);else{const e=target[name];target[name]=function(...t){let n="function"==typeof replace?replace.apply(this,[t,...t]):void 0,result="function"!=typeof e||n?void 0:e.apply(this,t);return"function"==typeof str&&str.apply(this,[result,...t]),n??result}}return target[name]},reWriteFunctionX(target,name,replace){if(name&&"object"==typeof name)return app.each(name,(e,t)=>app.reWriteFunction(target,t,e),target);if(!Array.isArray(replace))return target[name];let[item1,item2,item3]=replace;if("append"===item3?item2=item1+item2:"insert"===item3&&(item2+=item1),"string"==typeof item1&&(item1=new RegExp(item1)),item1 instanceof RegExp&&"string"==typeof item2)eval(`target.${name} = ${target[name].toString().replace(item1,item2)}`);else{const e=target[name];target[name]=function(...t){let result=app.isFunction(item1)?item1.apply(this,[t,...t]):void 0;return app.isFunction(e)&&!result&&(result=e.apply(this,t)),app.isFunction(item2)&&item2.apply(this,[result,...t]),result}}return target[name]},waitAllFunction(e,t){const n=e.slice(),i=()=>{const e=n.shift();"function"==typeof e?e(i):0===n.length?t():i()};i()},element:{runNext:{setTip:e=>console.info(e)}},get:{skillInfo(e,t){const n={id:e},i=lib.skill[e];return n.info=i,n.name=lib.translate[`${e}_ab`]||lib.translate[e],n.nameSimple=lib.translate[`${e}_ab`]||lib.translate[e]?.slice(0,2),t&&(n.forbidden=!!t.forbiddenSkills?.[e],n.disabled=!!t.disabledSkills?.[e],n.temp=i?.temp||!t.skills?.includes(e),n.frequent=!(!i?.frequent&&!i?.subfrequent),n.clickable=!!(i?.clickable&&t.isIn()&&t.isUnderControl(!0)),n.nobracket=!!i?.nobracket),n.translation=get.skillInfoTranslation(e,void 0,!1),n.translationSource=lib.translate[`${e}_info`],n.translationAppend=lib.translate[`${e}_append`],n.type=i?.enable?"enable":"trigger",n}},listen(e,t){const n=lib.config.touchscreen?"touchend":"click";return e.addEventListener(n,t),()=>e.removeEventListener(n,t)},mockTouch(e){const t=lib.config.touchscreen?"touchend":"click";return e.dispatchEvent(new Event(t)),e},nextTick(e,t){const n=Array.isArray(e)?e.slice():[e],i=()=>{const e=n.shift();e&&setTimeout(()=>{e(),i()},t||0)};i()}},lib.config.dev&&(window.app=app)}export{initApp};
