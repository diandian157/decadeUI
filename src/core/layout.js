import{ui,game,lib}from"noname";function e(){return{update(){this.updateHand(),this.updateDiscard()},updateHand(){if(!game.me)return;const e=ui.handcards1;if(!e)return console.error("hand undefined");const t=[...e.childNodes].filter(card=>!card.classList.contains("removing")||(card.scaled=!1,!1));if(!t.length)return;const a=decadeUI.boundsCaches.hand;a.check();const{width:d,cardWidth:i,cardHeight:s,cardScale:n,x:o}=a,c=i*n,l=Math.round((s*n-s)/2);let r=c+2,h=(c-i)/2;const m=t.length*c+2*(t.length-1),u=d;let f=!1;if(m>u){if(r=c-Math.abs(u-c*t.length)/(t.length-1),lib.config.fold_card){const e=parseFloat(lib.config.extension_十周年UI_handFoldMin)||9,t=n*e;r<t&&(f=!0,r=t)}}else{const e=decadeUI?.config?.newDecadeStyle??lib.config.extension_十周年UI_newDecadeStyle;("codename"===e||("on"===e||"othersOff"===e)&&!lib.config.phonelayout)&&(h=(ui.arena.offsetWidth-m)/2-o)}let g=-1,y=0,p=0,I=0;if(m>u&&r<c-.5&&!f&&"function"==typeof ui.getSpreadOffset){const e=ui.getSpreadOffset(t,{cardWidth:c,currentMargin:r});if(({spreadIndex:g,spreadLeft:y,spreadRight:p}=e),-1!==g){const e=h+g*r,t=Math.max(0,u-c);I=Math.round(Math.max(0,Math.min(t,e))-e)}}t.forEach((card,e)=>{let t=h+e*r+I;(y||p)&&(e<g?t-=y:e>g&&(t+=p));const a=Math.round(t);card.tx=a,card.ty=l,card.scaled=!0,card.style.transform=`translate(${a}px,${l}px) scale(${n})`,card._transform=card.style.transform,card.updateTransform(card.classList.contains("selected"))});const U=ui.handcards1Container;f?(U.classList.add("scrollh"),U.style.overflowX="scroll",U.style.overflowY="hidden",e.style.width=`${Math.round(t.length*r+(c-r))}px`):(U.classList.remove("scrollh"),U.style.overflowX=U.style.overflowY="",e.style.width="100%")},updateDiscard(){if(ui.thrown??=[],ui.thrown=ui.thrown.filter(e=>!(e.classList.contains("drawingcard")||e.classList.contains("removing")||e.parentNode!==ui.arena||e.fixed)&&(e.classList.remove("removing"),!0)),!ui.thrown.length)return;const e=ui.thrown,t=decadeUI.boundsCaches.arena;t.check();const{width:a,height:d,cardWidth:i,cardHeight:s}=t,n=Math.min(decadeUI.get.bodySize().height*(lib.config?.extension_十周年UI_discardScale??.14)/s,1),o=i*n,c=Math.round((d-s)/2),l=.7*a,r=e.length*o+2*(e.length-1),h=Math.min(l,a);let m=o+2,u=(a-Math.min(r,h))/2+(o-i)/2;r>h&&(m=(h-o)/(e.length-1)),e.forEach((card,e)=>{const t=Math.round(u+e*m);card.tx=t,card.ty=c,card.scaled=!0,card.style.transform=`translate(${t}px,${c}px) scale(${n})`})},clearout(card){!card||card.fixed||card.classList.contains("removing")||(card.name?.startsWith("shengbei_left_")||card.name?.startsWith("shengbei_right_")?card.delete():(ui.thrown.includes(card)||(ui.thrown.unshift(card),decadeUI.queueNextFrameTick(decadeUI.layoutDiscard,decadeUI)),card.classList.add("invalided"),setTimeout(e=>{e.remove(),decadeUI.queueNextFrameTick(decadeUI.layoutDiscard,decadeUI)},2333,card)))},_debounce(e){const{defaultDelay:t,maxDelay:a,timeoutKey:d,timeKey:i,immediateCallback:s,callback:n}=e,o=Date.now();if(this[d]){if(clearTimeout(this[d]),o-this[i]>a)return this[d]=this[i]=null,void s()}else this[i]=o;this[d]=setTimeout(()=>{this[d]=this[i]=null,n()},this[d]?o-this[i]:t)},delayClear(){this._debounce({defaultDelay:500,maxDelay:1e3,timeoutKey:"_delayClearTimeout",timeKey:"_delayClearTimeoutTime",immediateCallback:ui.clear,callback:ui.clear})},invalidate(){this.invalidateHand(),this.invalidateDiscard()},invalidateHand(){this._debounce({defaultDelay:40,maxDelay:180,timeoutKey:"_handcardTimeout",timeKey:"_handcardTimeoutTime",immediateCallback:()=>this.updateHand(),callback:()=>this.updateHand()})},invalidateDiscard(){this._debounce({defaultDelay:ui.thrown?.length>15?80:40,maxDelay:180,timeoutKey:"_discardTimeout",timeKey:"_discardTimeoutTime",immediateCallback:()=>this.updateDiscard(),callback:()=>this.updateDiscard()})},resize(){if(!ui.arena)return;ui.arena.classList.toggle("dui-mobile",decadeUI.isMobile()),decadeUI.dataset.animSizeUpdated=!1,decadeUI.dataset.bodySize.updated=!1,Object.values(decadeUI.boundsCaches).forEach(e=>e.updated=!1);const e=e=>decadeUI.sheet.getStyle(e)||decadeUI.sheet.insertRule(`${e} { zoom: 1; }`),t=e("#window > .dialog.popped .buttons:not(.smallzoom)"),a=e("#arena:not(.choose-character) .buttons:not(.smallzoom)");decadeUI.zooms.card=decadeUI.getCardBestScale(),ui.me&&(ui.me.style.height=`${Math.round(decadeUI.getHandCardSize().height*decadeUI.zooms.card+30.4)}px`),a&&(a.zoom=decadeUI.zooms.card),t&&(t.zoom=decadeUI.zooms.card),this.invalidate()}}}export{e as createLayoutModule};
