import{lib,get,ui,game}from"noname";const e="equipHand";function s(s){const card=ui.create.card(ui.special);return card.init([s.suit,s.number,s.name,s.nature]),card.cardid=s.cardid,card.wunature=s.wunature,card.storage=s.storage,card.relatedCard=s,card.owner=get.owner(s),new MutationObserver(s=>{if("s"===get.position(card)&&card.hasGaintag(e))for(const e of s){if("class"!==e.attributeName)continue;ui.selected.cards.remove(card);const s=card.classList.contains("selected");card.updateTransform(s,0),card.relatedCard.classList.toggle("selected",s),s?ui.selected.cards.add(card.relatedCard):ui.selected.cards.remove(card.relatedCard)}}).observe(card,{attributes:!0,attributeFilter:["class"]}),card}function t(){const t=["chooseCard","chooseToUse","chooseToRespond","chooseToDiscard","chooseCardTarget","chooseToGive"];lib.hooks.checkBegin.add(async event=>{if(lib.config["extension_十周年UI_aloneEquip"])return;const player=event.player;if(!(event.position?.includes("e")&&player.countCards("e")&&!event.copyCards&&t.includes(event.name)))return;event.copyCards=!0;const a=!event.position.includes("s");a&&(event.position+="s");const r=player.getCards("e").map(s);let o=[],result=[];event.filterCard&&(o=r.filter(e=>event.filterCard.call(event,e.relatedCard||e,player)),event.filterCard=function(s,t){return function(card,player){const a=card.relatedCard||card;return"e"!==get.position(card)&&!(t&&"s"===get.position(card)&&"card"===get.itemtype(card)&&!card.hasGaintag(e))&&s.call(this,a,player)}}(event.filterCard,a));const n=function(event,player,e,s,result){if(!event.filterCard||!("object"==typeof event.selectCard||event.selectCard>1))return event.filterCard?s:e;result.addArray(s);const t=player.getCards("he",e=>{const s=e.relatedCard||e;return event.position.includes(get.position(s))&&event.filterCard.call(event,s,player)});for(const a of t)ui.selected.cards=ui.selected.cards||[],ui.selected.cards.add(a),result.addArray(e.filter(e=>{if(result.includes(e))return!1;const s=e.relatedCard||e;return event.position.includes(get.position(s))&&event.filterCard.call(event,s,player)})),ui.selected.cards.remove(a);return result}(event,player,r,o,result);n.length&&player.directgains(n,null,e),function(e){for(const card of e)card.node.gaintag.classList.remove("gaintag","info"),card.node.gaintag.innerHTML='<div class="epclick"></div>'}([...r,...o,...result]),r.sort((e,s)=>s.name!==e.name?lib.sort.card(s.name,e.name):s.suit!==e.suit?lib.suit.indexOf(s)-lib.suit.indexOf(e):s.number-e.number)}),lib.hooks.checkCard.add((card,event)=>{if(!lib.config["extension_十周年UI_aloneEquip"]&&event.copyCards&&"e"===get.position(card)&&card.classList.contains("selected")){const s=event.player.getCards("s",s=>s.hasGaintag(e)&&s.relatedCard===card)[0];s&&!s.classList.contains("selected")&&(card.classList.remove("selected"),ui.selected.cards.remove(card))}}),lib.hooks.checkEnd.add(event=>{if(!lib.config["extension_十周年UI_aloneEquip"]&&event.copyCards)for(const s of event.player.getCards("e"))if(s.classList.contains("selected")){const t=event.player.getCards("s",t=>t.hasGaintag(e)&&t.relatedCard===s)[0];t&&!t.classList.contains("selected")&&(s.classList.remove("selected"),ui.selected.cards.remove(s))}}),lib.hooks.uncheckBegin.add(async(event,s)=>{if(lib.config["extension_十周年UI_aloneEquip"])return;s.includes("card")&&event.copyCards&&(event.result||["chooseToUse","chooseToRespond"].includes(event.name)&&!event.skill&&!event.result)&&function(event,player){const s=event.result?.cards;s&&s.forEach((card,t)=>{if(card.hasGaintag(e)){const e=player.getCards("e",e=>e.cardid===card.cardid)[0];e&&(s[t]=e)}}),player?.getCards("s",s=>s.hasGaintag(e)).forEach(e=>{e.discard(),e.delete()}),event.copyCards=!1,player===game.me&&ui.updatehl()}(event,event.player)})}export{t as setupEquipCopy};
