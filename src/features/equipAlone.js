import{ui,lib,get,_status,game}from"noname";const e=player=>player?.node?.equips?Array.from(player.node.equips.childNodes):[];function i(e){const i=lib.card[e];return i?.skills?game.expandSkills(i.skills.slice()):[]}function l(event,player){if(!event._skillChoice)return[];const e=function(player){const e=/* @__PURE__ */new Set;for(const card of player.getCards("e"))for(const l of i(card.name))e.add(l);return e}(player);return event._skillChoice.filter(i=>{return l=i,!0===lib.skill[l]?.equipSkill||e.has(i);var l})}function t(e,l){if(!e||!Array.isArray(e)||0===e.length)return[];const[t,s]=e;if(t){const e=l.filter(e=>{return i=e,lib.skill[i]?.sourceSkill===t;var i});if(e.length)return e}return s?i(s).filter(e=>l.includes(e)):[]}function s(card,e){return i(card.name).filter(i=>e.includes(i))}function n(e){o(),ui.click.skill(e)}function o(){if(game.me)for(const i of e(game.me))i.classList.contains("selected")||i.classList.remove("selectable"),i.classList.remove("equip-card-selectable"),delete i._equipSkills}function c(){const i=ui.click.card;ui.click.card=function(){const e=lib.config["extension_十周年UI_aloneEquip"],l=this._equipSkills?.length,t=this.classList.contains("selectable"),s="e"===get.position(this)||this.extraEquip;return e&&l&&t&&s?(_status.clicked=!0,_status.touchnocheck=!1,_status.mousedown=!1,void(1===this._equipSkills.length?n(this._equipSkills[0]):function(e){ui._equipSkillDialog&&(ui._equipSkillDialog.close(),delete ui._equipSkillDialog);const i=ui.create.dialog("选择要发动的技能","hidden");ui._equipSkillDialog=i;const l=lib.config.touchscreen?"touchend":"click";for(const t of e){const e=i.add(`<div class="popup text pointerdiv" style="width:calc(100% - 10px);display:inline-block">${get.skillTranslation(t,game.me,!0)}</div>`);e.firstChild.link=t,e.firstChild.addEventListener(l,function(e){e.stopPropagation(),i.close(),delete ui._equipSkillDialog,n(this.link)})}i.forcebutton=!0,i.classList.add("forcebutton"),i.open()}(this._equipSkills))):i.apply(this,arguments)},lib.hooks.checkEnd.add(event=>{if(!lib.config["extension_十周年UI_aloneEquip"])return;const player=event.player;if(player!==game.me||!event.isMine?.()||_status.auto)return;o(),function(event,player){const e=event?.position;if("string"==typeof e&&e.includes("e")&&!(ui.selected.cards.length>=get.select(event.selectCard)[1]))for(const card of player.getCards("e"))event.filterCard?.(card,player,event)&&(card.classList.contains("selected")||card.classList.add("selectable"),card.classList.add("equip-card-selectable"))}(event,player);const i=l(event,player);i.length&&function(player,i){for(const l of e(player)){let e=[];l.extraEquip?e=t(l.extraEquip,i):"e"===get.position(l)&&(e=s(l,i)),e.length&&(l.classList.add("selectable"),l._equipSkills=e)}}(player,i)}),lib.hooks.uncheckBegin.add(()=>{lib.config["extension_十周年UI_aloneEquip"]&&(ui._equipSkillDialog&&(ui._equipSkillDialog.close(),delete ui._equipSkillDialog),o())})}export{o as clearEquipSelectable,c as setupEquipAlone};
