import{lib,_status,get,game,ui}from"noname";class e{static FREE_CHANGES=3;static clearTimers(){["timer","timer2"].forEach(e=>{window[e]&&(clearInterval(window[e]),delete window[e])})}static removeProgressBar(){document.getElementById("jindutiaopl")?.remove()}static showTimer(){this.clearTimers(),this.removeProgressBar(),"0"!==lib.config.extension_十周年UI_jindutiaoYangshi&&game.Jindutiaoplayer?.()}static hideTimer(){this.clearTimers(),this.removeProgressBar()}static closeCardDialog(){ui.cardDialog&&(delete ui.cardDialog._isLuckyCardTip,ui.cardDialog.close(),delete ui.cardDialog)}static stripTags(e){return"string"==typeof e?e.replace(/<\/?.+?\/?>/g,""):""}static setupConfirmButton(){if(!ui.confirm?.childNodes?.length)return;if("off"===lib.config.extension_十周年UI_newDecadeStyle)return;const e=ui.confirm.childNodes[0];"ok"===e?.link&&(e.innerHTML="换牌")}static getPromptText(e,a){return e>0?`本场还可免费更换<span style='color:#00c853'>${e}次</span>手牌(剩余${a}张手气卡)`:`每次更换消耗一张手气卡(剩余<span style='color:#00c853'>${a}</span>张手气卡)`}static canChange(e,a){return e>0||a>0}static showDialog(e){if(this.showTimer(),"function"==typeof decadeUI?.showHandTip){this.closeCardDialog();const a=ui.cardDialog=decadeUI.showHandTip();return a._isLuckyCardTip=!0,a.appendText(this.stripTags(e)),a.strokeText(),a.show(),null}return ui.create.dialog(e)}static cleanup(e){this.hideTimer(),this.closeCardDialog(),e?.close(),ui.confirm?.close()}}class a{static dealCardsToPlayer(player,e,a){const t="function"==typeof e?e(player):e,r=[],i=a.otherPile?.[player.playerid]?.getCards;if(i?r.addArray(i(t)):player.getTopCards?r.addArray(player.getTopCards(t)):r.addArray(get.cards(t)),a.gaintag?.[player.playerid]){const e=a.gaintag[player.playerid],i="function"==typeof e?e(t,r):[[r,e]];game.broadcastAll((e,a)=>{for(let t=a.length-1;t>=0;t--)e.directgain(a[t][0],null,a[t][1])},player,i)}else player.directgain(r);!0!==player.singleHp||"guozhan"===get.mode()||"doudizhu"===lib.config.mode&&"online"===_status.mode||player.doubleDraw(),player._start_cards=player.getCards("h")}static dealCardsToAll(player,e,a){const t=player;do{this.dealCardsToPlayer(player,e,a),player=player.next}while(player!==t)}static canShowChangeDialog(a){return"disabled"!==a.changeCard&&!_status.auto&&game.me.countCards("h")>0&&e.canChange(a.freeChanges,a.luckyCards)}static performCardChange(e){game.changeCoin?.(-3);const a=game.me.getCards("h"),t=[],r=e.otherPile?.[game.me.playerid]?.getCards,i=e.otherPile?.[game.me.playerid]?.discard;game.addVideo("lose",game.me,[get.cardsInfo(a),[],[],[]]);for(const card of a)card.removeGaintag(!0),i?i(card):card.discard(!1);if(r?t.addArray(r(a.length)):t.addArray(get.cards(a.length)),e.gaintag?.[game.me.playerid]){const r=e.gaintag[game.me.playerid],i="function"==typeof r?r(a.length,t):[[t,r]];for(let e=i.length-1;e>=0;e--)game.me.directgain(i[e][0],null,i[e][1])}else game.me.directgain(t);game.me._start_cards=game.me.getCards("h"),e.freeChanges>0?e.freeChanges--:e.luckyCards--}}function t(){return new Promise(e=>{_status.imchoosing=!0;const a=_status.event;a.switchToAuto=()=>{_status.imchoosing=!1,e(!1)},a.custom.replace.confirm=a=>{_status.imchoosing=!1,_status.event.bool=a,e(a),game.resume()},game.pause()})}function r(){lib._luckyCard=e,lib.element.content.gameDraw=async function(){if(_status.brawl?.noGameDraw)return;const r={player:this.player,num:this.num,otherPile:this.otherPile,gaintag:this.gaintag,changeCard:get.config("change_card"),freeChanges:e.FREE_CHANGES,luckyCards:1e4+Math.floor(9e4*Math.random())};a.dealCardsToAll(r.player,r.num,r),(_status.connectMode||"single"===lib.config.mode&&"wuxianhuoli"!==_status.mode||"doudizhu"===lib.config.mode&&"online"===_status.mode||!["identity","guozhan","doudizhu","single"].includes(lib.config.mode))&&(r.changeCard="disabled"),a.canShowChangeDialog(r)?await async function(r){for(;a.canShowChangeDialog(r);){const i=e.getPromptText(r.freeChanges,r.luckyCards),n=e.showDialog(i);ui.create.confirm("oc"),e.setupConfirmButton();const o=await t();if("once"===r.changeCard?r.changeCard="disabled":"twice"===r.changeCard&&(r.changeCard="once"),!o){e.cleanup(n),game.me._start_cards=game.me.getCards("h");break}if(a.performCardChange(r),e.cleanup(n),"disabled"===r.changeCard||!e.canChange(r.freeChanges,r.luckyCards))break}setTimeout(()=>decadeUI.effect?.gameStart?.(),51)}(r):setTimeout(()=>decadeUI.effect?.gameStart?.(),51)}}export{r as setupLuckyCard};
