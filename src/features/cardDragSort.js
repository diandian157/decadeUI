import{lib,ui,game,_status}from"noname";let e=null,t=null,n=null,a=0,r=0,s={x:0,y:0,scale:1},o=null,i=null;const d=/(iPhone|iPod|Android|ios|iPad|Mobile)/i.test(navigator.userAgent),c="PointerEvent"in window,l=c?["pointerdown","pointermove","pointerup"]:d?["touchstart","touchmove","touchend"]:["mousedown","mousemove","mouseup"],u=c?"pointercancel":d?"touchcancel":null,m=e=>new Promise(t=>requestAnimationFrame(()=>t(e()))),p=e=>c?e:e.touches?.[0]??e.changedTouches?.[0]??e,g=e=>e?.closest?.(".card")??null,f=()=>ui?.handcards1Container?.classList.contains("scrollh")||"scroll"===getComputedStyle(ui?.handcards1Container).overflowX,w=async(card,e,t,n=card?.scale??1)=>{card&&Number.isFinite(e)&&Number.isFinite(t)&&await m(()=>{card.tx=e,card.ty=t,card.style.transform=card._transform=`translate(${e}px, ${t}px) scale(${n})`})},y=async(a=!1)=>{const card=t;card&&("sort"!==e||n||(card.style.transform=`translate(${s.x}px, ${s.y}px) scale(${s.scale})`),Object.assign(card.style,{transition:"",pointerEvents:o??"",opacity:"1",zIndex:""}),document.removeEventListener(l[1],x),document.removeEventListener(l[2],b),u&&document.removeEventListener(u,b),window.removeEventListener("blur",b),t=n=e=i=null,a||m(()=>window.decadeUI?.layout?.updateHand?.()),_status.dragged=null)},v=async n=>{if(!lib.config.enable_drag)return;if(game.me?.hasSkillTag("noSortCard"))return;if(!c&&2===n.button)return;if(f())return;t&&await y(!0);const card=g(n.target);if(!card||card.parentNode!==ui.handcards1)return;const{clientX:d,clientY:w}=p(n),v=await(h=card,m(()=>{try{const e=new DOMMatrixReadOnly(getComputedStyle(h).transform);return{x:e.m41,y:e.m42,scale:e.m11}}catch{return{x:0,y:0,scale:1}}}));var h;t=card,a=d,r=w,s={x:v.x,y:v.y,scale:v.scale},card.scale=v.scale,e=null,o=getComputedStyle(card).pointerEvents,i=card._waitingfordrag||{clientX:d,clientY:w},delete card._waitingfordrag,document.addEventListener(l[1],x,{passive:!1}),document.addEventListener(l[2],b,{passive:!1}),u&&document.addEventListener(u,b,{passive:!1}),window.addEventListener("blur",b,{once:!0})},x=async o=>{const card=t;if(!card)return;if(f())return y();_status.dragged=!0;const{clientX:d,clientY:c,pageX:l,pageY:u}=p(o),m=d-a,w=c-r,v=Math.abs(m),x=Math.abs(w);if(!e){if(Math.sqrt(m*m+w*w)<5)return;if(x>v||w<-50)return e="escaped",i&&(card._waitingfordrag=i),y(!0);e="sort",o.preventDefault(),o.stopPropagation(),_status.mousedragging=_status.mousedragorigin=null,delete card._waitingfordrag,Object.assign(card.style,{pointerEvents:"none",transition:"none",opacity:"0.5",zIndex:"99"})}if("sort"===e){if(w<-50)return card.style.transform=`translate(${s.x}px, ${s.y}px) scale(${s.scale})`,e="escaped",i&&(card._waitingfordrag=i),y(!0);o.preventDefault(),o.stopPropagation();const t=window.game?.documentZoom??1;card.style.transform=`translate(${s.x+m/t}px, ${s.y}px) scale(${card.scale})`;const a=g(document.elementFromPoint(l,u));a&&a!==card&&a.parentNode===ui.handcards1&&n!==a&&(n=a,await h(card,a))}},h=async(e,t)=>{const n=ui.handcards1,a=Array.from(n.childNodes),r=a.indexOf(e),o=a.indexOf(t);if(-1===r||-1===o)return;const i=window.decadeUI?.boundsCaches?.hand?.cardScale??1,d=r>o;n.insertBefore(e,d?t:t.nextSibling);const c=Number.isFinite(e.tx)?e.tx:s.x;await w(e,t.tx,s.y,i),await w(t,c,t.ty,i);const[l,u]=d?[o+1,r]:[r,o-1],p=Array.from(n.childNodes);await Promise.all(p.slice(l,u+1).map(async t=>{if(!t||t===e||void 0===t.tx)return;const n=a[a.indexOf(t)+(d?-1:1)];n&&await w(t,n.tx,t.ty,i)})),m(()=>window.decadeUI?.layout?.updateHand?.())},b=n=>{if("sort"===e&&(n?.preventDefault?.(),n?.stopPropagation?.(),n?.stopImmediatePropagation?.(),_status.mousedragging=_status.mousedragorigin=null,_status.mouseleft=!1,_status.clicked=!0,t&&(delete t._waitingfordrag,t.classList.contains("selected")))){t.classList.remove("selected");const e=ui.selected.cards.indexOf(t);e>-1&&ui.selected.cards.splice(e,1),game.uncheck(),game.check()}y()},E=async()=>{if(!ui?.handcards1)return setTimeout(E,1e3);ui.handcards1.removeEventListener(l[0],v),ui.handcards1.addEventListener(l[0],v,{passive:!1})},L=()=>{y(!0),ui?.handcards1?.removeEventListener(l[0],v)};function $(e=lib.config.enable_drag){const t=window.decadeUI||{};window.decadeUI=t,Object.assign(t,{initCardDragSwap:E,destroyCardDragSwap:L}),"complete"===document.readyState?setTimeout(E,1e3):window.addEventListener("load",()=>setTimeout(E,1e3),{once:!0})}export{$ as setupCardDragSort};
