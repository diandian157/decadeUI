import{get,lib,ui}from"noname";import{CONFIG as e,GENERAL_NAME_STYLE as t}from"./config.js";import{isPlayer as n,getName as i,getDefaultAvatar as a,toKebab as r}from"./utils.js";import{checkImageExists as c,getOutcropStyle as o,getOutcropImagePath as s}from"../ui/outcropAvatar.js";function f(player,a,f){if(!n(player))return;const g=decadeUI.animation,m=g.spine.assets.effect_xianding;if(!m)return void console.error("[effect_xianding]特效未加载");m.ready||g.prepSpine("effect_xianding");const u="vice"===f,l=player.group,p=i(player,u);!async function(n,i,player,a,f){try{const g=await async function(e){if(!e)return null;const t=get.character(e),n=get.mode();let i=e;lib.characterPack[`mode_${n}`]?.[e]&&"guozhan"===n&&(i=e.startsWith("gz_shibing")?e.slice(3,11):e.slice(3));if(lib.config.skin[i])return lib.config.skin[i][1];if(t?.img)return t.img;if(t?.trashBin)for(const c of t.trashBin){if(c.startsWith("img:"))return c.slice(4);if(c.startsWith("ext:"))return c.replace(/^ext:/,"extension/")}const a=`${lib.assetURL}extension/十周年UI/image/character/lihui/${i}.jpg`;if(await c(a))return a;const r=o();if("off"!==r){const e=s(i,r);if(e&&await c(e))return e}return`${lib.assetURL}image/character/${i}.jpg`}(n),[m,u]=await Promise.all([d(g,player,n),h(i)]);!function(n,i,a,c,o){const s=decadeUI.animation,f=s.playSpine("effect_xianding");if(!f?.skeleton)return void console.error("Spine动画加载失败");const d=f.skeleton;(function(e,t,n,i,a){const r=e.findSlot(t),c=r.getAttachment();if(c.camp===a)return;c.cached=c.cached||{},c.cached[a]||(c.cached[a]=i.createTextureRegion(n));const o=c.cached[a];c.width=o.width,c.height=o.height,c.setRegion(o),c.updateOffset(),c.camp=a})(d,"shilidipan",i,s,a),function(t,n,i){const a=t.findSlot("wujiang"),r=a.getAttachment(),c=i.createTextureRegion(n),o=Math.min(e.SKILL_MAX_W/c.width,e.SKILL_MAX_H/c.height);r.width=c.width*o,r.height=c.height*o,r.setRegion(c),r.updateOffset()}(d,n,s);const h=d.bounds.size;f.scale=Math.max(s.canvas.width/h.x,s.canvas.height/h.y),function(n,i,a){const c=decadeUI.element.create("skill-name");c.innerHTML=n,c.style.top=`calc(50% + ${e.SKILL_NAME_Y*a}px)`;const o=decadeUI.element.create("general-name");o.innerHTML=i;const s={...t,right:`calc(50% - ${e.GENERAL_X*a}px)`,top:`calc(50% - ${e.GENERAL_Y*a}px)`};o.style.cssText=Object.entries(s).map(([e,t])=>`${r(e)}: ${t}`).join("; "),ui.arena.appendChild(c),ui.arena.appendChild(o),c.removeSelf(e.EFFECT_DURATION),o.removeSelf(e.EFFECT_DURATION)}(c,o,f.scale)}(m,u,i,a,f)}catch(g){console.error("技能特效加载失败:",g)}}(u?player.name2:player.name,l,player,a,p)}function d(e,player,t){return new Promise((t,n)=>{if(!e)return void n(new Error("图片路径为空"));const i=new Image;i.onload=()=>t(i),i.onerror=async()=>{const r=await async function(e,player){return a(player)}(0,player);r&&r!==e?(i.onload=()=>t(i),i.onerror=()=>n(new Error("图片加载失败")),i.src=r):n(new Error("图片加载失败"))},i.src=e.startsWith("http")||e.startsWith("data:")?e:`${lib.assetURL}${e.replace(lib.assetURL,"")}`})}function h(e){return new Promise(t=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>{n.onload=()=>t(n),n.src=`${decadeUIPath}image/ui/misc/bg_xianding_qun.png`},n.src=`${decadeUIPath}image/ui/misc/bg_xianding_${e}.png`})}export{f as playSkillEffect};
