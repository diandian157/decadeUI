import{ui,lib,game}from"noname";import{addClickEffect as addClickEffect$1,hideDialog as hideDialog$1}from"../utils.js";const MAX_CHAT_RECORDS=50,DIALOG_HIDE_DELAY=1e3,DIALOG_LIFESAY_HIDE_DELAY=100,DIALOG_ANIMATION_DELAY=100,XUWU_COUNT=10,XUWU_DELAY=100,THROW_ITEMS=[{name:"meijiu",left:"-155px",bottom:"150px",image:"meijiu",label:"酒杯",emotionType:"wine"},{name:"xianhua",left:"-230px",bottom:"150px",image:"xianhua",label:"鲜花",emotionType:"flower"},{name:"tuoxie",left:"-155px",bottom:"82px",image:"tuoxie",label:"拖鞋",emotionType:"shoe"},{name:"jidan",left:"-230px",bottom:"82px",image:"jidan",label:"鸡蛋",emotionType:"egg"},{name:"cailan",left:"-80px",bottom:"150px",image:"cailan",label:"荷花",emotionType:"flower"},{name:"qicai",left:"-155px",bottom:"13px",image:"qicai",label:"烟花",emotionType:"flower"},{name:"xiaojiu",left:"-230px",bottom:"13px",image:"xiaojiu",label:"灯笼",emotionType:"wine"},{name:"xueqiu",left:"-80px",bottom:"82px",image:"xueqiu",label:"雪球",emotionType:"wine"}],THROW_ITEM_NAMES=["jidan","tuoxie","xianhua","meijiu","cailan","qicai","xiaojiu","xueqiu","xuwu"];function getCurrentPlayer(){return game.me?game.me:game.connectPlayers?game.online?game.connectPlayers.find(e=>e.playerid===game.onlineID):game.connectPlayers[0]:null}function sendChatMessage(e){const t=getCurrentPlayer();if(t){if(e.startsWith("/playAudio ")){const o=e.indexOf(" ",11);if(-1!==o){const i=e.slice(11,o),a=e.slice(o+1);return"function"==typeof game.playAudio&&game.playAudio(i),void(a&&(game.online?game.send("chat",game.onlineID,a):t.chat(a)))}{const t=e.slice(11);return void(t&&"function"==typeof game.playAudio&&game.playAudio(t))}}game.online?game.send("chat",game.onlineID,e):t.chat(e)}}function throwEmotion(e,t){game.online?game.send("throwEmotion",e,t):game.me.throwEmotion(e,t),window.shuliang&&(window.shuliang.innerText=parseInt(window.shuliang.innerText)-1)}function isInThrowMode(){return THROW_ITEM_NAMES.some(e=>window[e]?.thrownn)}function exitThrowMode(){THROW_ITEM_NAMES.forEach(e=>{window[e]&&(window[e].thrownn=!1)})}const hideDialog=hideDialog$1;function hideOtherDialogs(e,t){t.forEach(({name:t,prop:o,value:i,delay:a})=>{t!==e&&window[t]&&hideDialog(window[t],o,i,a||DIALOG_HIDE_DELAY)})}function createDialogBase(e){const t=ui.create.div("hidden");return t.classList.add("popped","static"),t.show=!0,Object.assign(t.style,e.styles),e.backgroundImage&&t.setBackgroundImage(e.backgroundImage),e.zIndex&&(t.style.zIndex=e.zIndex),void 0!==e.boxShadow&&(t.style.boxShadow=e.boxShadow),e.animation&&setTimeout(()=>Object.assign(t.style,e.animation),DIALOG_ANIMATION_DELAY),ui.window.appendChild(t),t}function createContentContainer(e,t){const o=ui.create.div("hidden");return Object.assign(o.style,t),void 0!==lib&&lib.setScroll(o),e.appendChild(o),o}const addClickEffect=addClickEffect$1;function processAudioPath(e){const t="ext:";return{fullPath:(e.startsWith(t)?`../extension/${e.slice(4)}`:e).replace(/\.[^/.]+$/,"")}}function createVoiceItem(e,t,o,i,a){const n=ui.create.div("hidden","",a);return n.style.cssText="height:10%;width:100%;left:0%;top:0%;position:relative;",n.pos=t,n.content=o,i&&(n.audioPath=i),n.innerHTML=`<font color=white>${o}</font>`,e.appendChild(n),addClickEffect(n),n}function initChatRecord(){window.chatRecord||(window.chatRecord=[])}function addChatWord(e){initChatRecord(),window.chatRecord.length>MAX_CHAT_RECORDS&&window.chatRecord.shift(),e&&window.chatRecord.push(e);const t=window.chatRecord.map(e=>`<br>${e}<br>`).join("");window.chatBackground2&&(window.chatBackground2.innerHTML=t)}function closeLifesayDialog(){window.dialog_lifesay&&(window.dialog_lifesay.delete(),window.dialog_lifesay=void 0)}function closeEmojiDialog(){window.dialog_emoji&&(window.dialog_emoji.delete(),window.dialog_emoji=void 0)}function initChatSystem(lib,game,ui,get){const assetPath="extension/十周年UI/ui/assets/",chatAssetPath=`${assetPath}chat/`;initChatRecord();const EMOTION_SIZE=lib.config.extension_星之梦_emotionsize||50;game.addChatWord=e=>{window.chatRecord.length>MAX_CHAT_RECORDS&&window.chatRecord.shift(),e&&window.chatRecord.push(e),window.chatBackground2&&game.updateChatWord(window.chatRecord.map(e=>`<br>${e}<br>`).join(""))},game.updateChatWord=e=>{window.chatBackground2&&(window.chatBackground2.innerHTML=e)},game.showChatWordBackgroundX=()=>{if(window.chatBg?.show){window.chatBg.hide(),THROW_ITEM_NAMES.forEach(e=>{window[e]?.thrownn&&(window[e].thrownn=!1)}),window.chatBg.show=!1,window.chatOverlay&&(window.chatOverlay.remove(),window.chatOverlay=null);return void[{name:"dialog_lifesay",prop:"left",value:`-${window.dialog_lifesay?.style.width}`,delay:DIALOG_LIFESAY_HIDE_DELAY},{name:"dialog_emoji",prop:"top",value:"100%",delay:DIALOG_HIDE_DELAY},{name:"chatBackground",prop:"left",value:"100%",delay:DIALOG_HIDE_DELAY},{name:"dialog_emotion",prop:"bottom",value:"100%",delay:DIALOG_HIDE_DELAY}].forEach(({name:e,prop:t,value:o,delay:i})=>hideDialog(window[e],t,o,i))}window.chatOverlay=ui.create.div("hidden"),window.chatOverlay.style.cssText="position:fixed;left:0;top:0;width:100%;height:100%;z-index:98;background:transparent;",window.chatOverlay.onclick=e=>{if(isInThrowMode()){const t=document.elementsFromPoint(e.clientX,e.clientY),o=game.players?.find(e=>t.some(t=>e===t||e.contains(t)));o?.onclick?o.onclick.call(o):(exitThrowMode(),game.showChatWordBackgroundX())}else game.showChatWordBackgroundX()},ui.window.appendChild(window.chatOverlay),window.chatBg=ui.create.div("hidden"),window.chatBg.classList.add("popped","static"),window.chatBg.show=!0,window.chatBg.style.cssText="display:block;--w:450px;--h:calc(var(--w)*300/900);width:var(--w);height:var(--h);position:fixed;left:30%;bottom:10%;opacity:1;background-size:100% 100%;background-color:transparent;z-index:99;transition:all 0.5s;",window.chatBg.setBackgroundImage(`${chatAssetPath}chat.png`),ui.window.appendChild(window.chatBg),window.hudongkuang=ui.create.div("hidden"),window.hudongkuang.style.cssText="display:block;--w:315px;--h:calc(var(--w)*135/142);width:var(--w);height:var(--h);left:-280px;bottom:-55px;transition:none;background-size:100% 100%;pointer-events:none;",window.hudongkuang.setBackgroundImage(`${chatAssetPath}hudong.png`),window.chatBg.appendChild(window.hudongkuang),game.open_lifesay=()=>{if(hideOtherDialogs("dialog_lifesay",[{name:"dialog_emoji",prop:"top",value:"100%"},{name:"chatBackground",prop:"left",value:"100%"},{name:"dialog_emotion",prop:"bottom",value:"100%"}]),window.dialog_lifesay?.show)return window.dialog_lifesay.hide(),void(window.dialog_lifesay.show=!1);window.dialog_lifesay=createDialogBase({styles:{height:"300px",width:"600px",left:"-600px",top:"calc(35% - 100px)",transition:"all 1s",opacity:"1",borderRadius:"8px",backgroundSize:"100% 100%"},backgroundImage:`${chatAssetPath}saydiv.png`,zIndex:999999999,boxShadow:"none",animation:{left:"calc(50% - 300px)"}});const e=createContentContainer(window.dialog_lifesay,{height:"70%",width:"80%",left:"10%",top:"10%",borderRadius:"8px",overflowY:"scroll"});let t=game.me?.getSkills?.(null,!1,!1).filter(e=>!get.info(e)?.charlotte)||[],o=[...t];t.forEach(e=>{const t=get.info(e);t?.derivation&&o.push(...Array.isArray(t.derivation)?t.derivation:[t.derivation])}),o=[...new Set(o)];let i=0;if(o.forEach(t=>{if(!get.info(t))return;const o=get.Audio.skill({skill:t,player:game.me.name}),{textList:a,fileList:n}=o;a.forEach((o,a)=>{const d=`「${get.skillTranslation(t)}」${o.replace(/~/g," ")}`,c=o.replace(/~/g," ");createVoiceItem(e,i++,d,n[a],function(){const{fullPath:e}=processAudioPath(this.audioPath);sendChatMessage(`/playAudio ${e} ${this.pureText}`),closeLifesayDialog()}).pureText=c})}),game.me?.name){const t=get.Audio.die({player:game.me.name}),{textList:o,fileList:a}=t;o.forEach((t,o)=>{const n=`「阵亡」${t.replace(/~/g," ")}`,d=t.replace(/~/g," ");createVoiceItem(e,i++,n,a[o],function(){const{fullPath:e}=processAudioPath(this.audioPath);sendChatMessage(`/playAudio ${e} ${this.pureText}`),closeLifesayDialog()}).pureText=d})}lib.quickVoice?.forEach((t,o)=>{createVoiceItem(e,i+o,t,null,function(){sendChatMessage(this.content),closeLifesayDialog()})})},window.chatButton1=ui.create.div("hidden","",game.open_lifesay),window.chatButton1.style.cssText="display:block;--w:75px;--h:calc(var(--w)*82/98);width:var(--w);height:var(--h);left:30px;bottom:15px;transition:none;background-size:100% 100%",window.chatButton1.setBackgroundImage(`${chatAssetPath}lifesay.png`),lib.setScroll(window.chatButton1),window.chatBg.appendChild(window.chatButton1),addClickEffect(window.chatButton1),THROW_ITEMS.forEach(e=>createThrowItemElement(e,chatAssetPath,game,ui,lib)),createXuwuElement(chatAssetPath,game,ui,lib),createCailanziElement(chatAssetPath,ui),createEmojiButton(chatAssetPath,EMOTION_SIZE,game,ui,lib),window.chatButton3=ui.create.div("hidden","",game.showChatWord),window.chatButton3.style.cssText="display:block;--w:75px;--h:calc(var(--w)*82/98);width:var(--w);height:var(--h);left:210px;bottom:15px;transition:none;background-size:100% 100%",window.chatButton3.setBackgroundImage(`${chatAssetPath}jilu.png`),lib.setScroll(window.chatButton3),window.chatBg.appendChild(window.chatButton3),addClickEffect(window.chatButton3),createSendButton(chatAssetPath),game.addChatWord(),createInputArea(chatAssetPath)},game.showChatWord=()=>{if(hideOtherDialogs("chatBackground",[{name:"dialog_lifesay",prop:"left",value:`-${window.dialog_lifesay?.style.width}`},{name:"dialog_emoji",prop:"top",value:"100%"},{name:"dialog_emotion",prop:"bottom",value:"100%"}]),window.chatBackground?.show)return window.chatBackground.hide(),void(window.chatBackground.show=!1);window.chatBackground=ui.create.div("hidden"),window.chatBackground.classList.add("static"),window.chatBackground.show=!0,window.chatBackground.style.cssText=`transition:all 1s;height:330px;width:600px;top:calc(35% - 100px);left:100%;bottom:calc(${window.chatBg?.style.height||"0"} + 5px);opacity:1;border-radius:10px;background-size:100% 100%;`,window.chatBackground.setBackgroundImage(`${chatAssetPath}saydiv.png`),window.chatBackground.style.zIndex=999999999,window.chatBackground.style.boxShadow="none",setTimeout(()=>window.chatBackground.style.left="calc(50% - 300px)",DIALOG_ANIMATION_DELAY),game.mouseChatDiv=e=>{void 0===lib.device?(e.onmouseover=function(){this.style.opacity="1.0"},e.onmouseout=function(){this.style.opacity="0.25"}):e.onclick=function(){this.style.opacity="0.25"===this.style.opacity?"0.75":"0.25"}},game.mouseChatDiv(window.chatBackground),ui.window.appendChild(window.chatBackground);const e=createContentContainer(window.chatBackground,{height:"70%",width:"80%",left:"10%",top:"10%",transition:"none",borderRadius:"8px",backgroundSize:"100% 100%"});window.chatBackground2=ui.create.div("hidden"),window.chatBackground2.style.cssText="height:100%;width:100%;left:0%;bottom:0%;transition:none;text-align:left;overflow-y:scroll;",window.chatBackground2.innerHTML="",lib.setScroll(window.chatBackground2),e.appendChild(window.chatBackground2),game.addChatWord()},lib._originalPlayerSay||(lib._originalPlayerSay=lib.element.player.say),lib.skill._wmkzSayChange={trigger:{global:["gameStart","phaseBegin","phaseAfter","useCardAfter"]},forced:!0,silent:!0,filter:(event,e)=>!0!==e.change_sayFunction,content(){const currentPlayer=player;currentPlayer.change_sayFunction=!0,currentPlayer.say=function(str){const thisPlayer=this,playerName=get.slimNameHorizontal(String(thisPlayer.name)),playerNickname=thisPlayer.nickname||null,assetURL=lib.assetURL;game.broadcastAll(function(playerNameArg,playerNicknameArg,messageStrArg,assetURLArg){var globalGame=function(){try{return eval("game")}catch(e){return window.game}}();if(globalGame){"function"!=typeof globalGame.addChatWord&&(window.chatRecord||(window.chatRecord=[]),globalGame.addChatWord=function(e){window.chatRecord.length>50&&window.chatRecord.shift(),e&&window.chatRecord.push(e),window.chatBackground2&&(window.chatBackground2.innerHTML=window.chatRecord.map(function(e){return"<br>"+e+"<br>"}).join(""))});var processedStr=messageStrArg.replace(/##assetURL##/g,assetURLArg),displayName=playerNicknameArg?playerNameArg+"["+playerNicknameArg+"]":playerNameArg;globalGame.addChatWord("<font color=green>"+displayName+"</font><font color=white>："+processedStr+"</font>")}},playerName,playerNickname,str,assetURL),lib._originalPlayerSay&&lib._originalPlayerSay.call(thisPlayer,str)}}}}function createThrowItemElement(e,t,o,i,a){const{name:n,left:d,bottom:c,image:l,label:r,emotionType:s}=e;o[`open_${n}`]=()=>{o.players.forEach(e=>{e.onclick=function(){window[n].thrownn&&throwEmotion(this,s)}})},window[n]=i.create.div("hidden","",o[`open_${n}`]),window[n].style.cssText=`display:block;--w:63px;--h:calc(var(--w)*50/50);width:var(--w);height:var(--h);left:${d};bottom:${c};transition:none;background-size:100% 100%`,window[n].setBackgroundImage(`${t}${l}.png`);const w=document.createElement("div");w.textContent=r,w.style.cssText="position:absolute;bottom:1px;left:0;right:0;text-align:center;color:rgba(255,220,0,0.7);font-size:12px;font-family:shousha;",window[n].appendChild(w),window[n].onclick=()=>{window[n].thrownn=!0},window.chatBg.appendChild(window[n]),void 0!==a&&a.setScroll(window[n]),addClickEffect(window[n])}function createXuwuElement(e,t,o,i){t.open_xuwu=()=>{t.players.forEach(e=>{e.onclick=function(){if(window.xuwu.thrownn)for(let e=0;e<XUWU_COUNT;e++)setTimeout(()=>throwEmotion(this,e<=8?"egg":"shoe"),XUWU_DELAY*e)}})},window.xuwu=o.create.div("hidden","",t.open_xuwu),window.xuwu.style.cssText="display:block;--w:63px;--h:calc(var(--w)*50/50);width:var(--w);height:var(--h);left:-80px;bottom:13px;transition:none;background-size:100% 100%",window.xuwu.setBackgroundImage(`${e}xuwu.png`);const a=document.createElement("div");a.textContent="鸡蛋风暴",a.style.cssText="position:absolute;bottom:1px;left:0;right:0;text-align:center;color:rgba(255,220,0,0.7);font-size:12px;font-family:shousha;",window.xuwu.appendChild(a),window.xuwu.onclick=()=>{window.xuwu.thrownn=!0},window.chatBg.appendChild(window.xuwu),void 0!==i&&i.setScroll(window.xuwu),addClickEffect(window.xuwu)}function createCailanziElement(e,t){window.cailanzi=t.create.div("hidden"),window.cailanzi.style.cssText="display:block;--w:100px;--h:calc(var(--w)*59/150);width:var(--w);height:var(--h);left:-230px;bottom:225px;transition:none;background-size:100% 100%",window.cailanzi.setBackgroundImage(`${e}cailanzi.png`),window.chatBg.appendChild(window.cailanzi),window.shuliang=t.create.node("div"),window.shuliang.innerText=Math.floor(900*Math.random()+100),window.shuliang.style.cssText="display:block;left:-180px;bottom:235px;font-family:shousha;color:#97856a;font-weight:900;text-shadow:none;transition:none;background-size:100% 100%",window.chatBg.appendChild(window.shuliang)}function createEmojiButton(e,t,o,i,a){o.open_emoji=()=>{if(hideOtherDialogs("dialog_emoji",[{name:"dialog_lifesay",prop:"left",value:`-${window.dialog_lifesay?.style.width}`},{name:"chatBackground",prop:"left",value:"100%"},{name:"dialog_emotion",prop:"bottom",value:"100%"}]),window.dialog_emoji?.show)return window.dialog_emoji.hide(),void(window.dialog_emoji.show=!1);window.dialog_emoji=createDialogBase({styles:{height:"330px",width:"600px",left:"calc(50% - 300px)",top:"100%",transition:"all 1s",opacity:"1",borderRadius:"8px",backgroundSize:"100% 100%"},backgroundImage:`${e}saydiv.png`,zIndex:999999999,boxShadow:"none",animation:{top:"calc(35% - 125px)"}});const n=createContentContainer(window.dialog_emoji,{height:"70%",width:"80%",left:"10%",top:"10%",borderRadius:"8px",overflowY:"scroll"}),d=`${a.assetURL}image/emotion/`,c=[];o.getFileList(d,e=>{e.filter(e=>"throw_emotion"!==e).forEach(e=>{c.push(e);const a=i.create.div("hidden","",function(){c.forEach(e=>{window[`dialog_emojiPack_${e}`]&&(window[`dialog_emojiPack_${e}`].style.display="none")}),document.querySelectorAll(".dialog_emojiContent").forEach(e=>{e.style.display=e.dataset.pack===this.packName?"":"none"})});a.style.cssText="height:70px;width:70px;margin:0 5px 5px 0;display:inline-block;left:15px;top:0px;position:relative;background-size:100% 100%;",a.packName=e,a.setBackgroundImage(`image/emotion/${e}/1.gif`),window[`dialog_emojiPack_${e}`]=a,n.appendChild(a),addClickEffect(a),o.getFileList(`${d}${e}/`,(o,a)=>{a.forEach(o=>{const a=i.create.div("hidden","",function(){c.forEach(e=>{window[`dialog_emojiPack_${e}`]&&(window[`dialog_emojiPack_${e}`].style.display="")}),document.querySelectorAll(".dialog_emojiContent").forEach(e=>{e.style.display="none"});sendChatMessage(`<img src="${d}${this.dataset.pack}/${this.dataset.file}" width="${parseInt(t)}" height="${parseInt(t)}">`),closeEmojiDialog()});a.className="dialog_emojiContent",a.style.cssText="height:70px;width:70px;margin:0 5px 5px 0;display:inline-block;left:15px;top:0px;position:relative;background-size:100% 100%;display:none;",a.dataset.pack=e,a.dataset.file=o,a.setBackgroundImage(`image/emotion/${e}/${o}`),n.appendChild(a),addClickEffect(a)})},()=>{})})},()=>{})},window.chatButton2=i.create.div("hidden","",o.open_emoji),window.chatButton2.style.cssText="display:block;--w:75px;--h:calc(var(--w)*82/98);width:var(--w);height:var(--h);left:120px;bottom:15px;transition:none;background-size:100% 100%",window.chatButton2.setBackgroundImage(`${e}emoji.png`),a.setScroll(window.chatButton2),window.chatBg.appendChild(window.chatButton2),addClickEffect(window.chatButton2)}function createSendButton(e){window.sendInfo=e=>{sendChatMessage(e),window.input&&(window.input.value="")},window.chatSendBottom=ui.create.div("","",()=>{window.input?.value&&window.sendInfo(window.input.value)}),window.chatSendBottom.style.cssText="display:block;--w:100px;--h:calc(var(--w)*62/160);width:var(--w);height:var(--h);left:72%;top:16%;transition:none;background-size:100% 100%;text-align:center;border-radius:8px;",window.chatSendBottom.setBackgroundImage(`${e}buttonsend.png`),window.chatSendBottom.innerHTML='<span style="color:#e6e6e6;font-size:23px;line-height:38px;font-weight:400;font-family:shousha">发送</span>',window.chatBg.appendChild(window.chatSendBottom),addClickEffect(window.chatSendBottom)}function createInputArea(e){const t=void 0!==lib?lib.assetURL:"";window.chatInputOut=ui.create.div("hidden"),window.chatInputOut.style.cssText="display:block;--w:275px;--h:calc(var(--w)*50/320);width:var(--w);height:var(--h);left:8%;top:14%;transition:none;background-size:100% 100%;pointer-events:none;z-index:6;",window.chatInputOut.style.backgroundImage=`url('${t}${e}sayX.png')`,window.chatBg.appendChild(window.chatInputOut),window.chatInput=ui.create.dialog("hidden"),window.chatInput.style.cssText="height:24px;width:44%;left:24.2%;top:31px;transition:none;",window.chatBg.appendChild(window.chatInput),window.ipt=ui.create.div(),window.ipt.style.cssText="height:24px;width:100%;top:0px;left:0px;margin:0px;border-radius:0px;background-image:linear-gradient(rgba(0,0,0,0.2),rgba(0,0,0,0.4));",window.input?.value&&(window.input_value=window.input.value),window.ipt.innerHTML=`<input type="text" value="${window.input_value||"请输入文字"}" style="color:white;font-family:shousha;width:calc(100% - 10px);text-align:left;"></input>`,window.input=window.ipt.querySelector("input"),window.input.style.backgroundImage=`url('${t}${e}say.png')`,window.input.style.backgroundSize="120% 120%",window.input.style.boxShadow="none",window.input.onclick=e=>e.stopPropagation(),window.input.onfocus=function(){"请输入文字"===this.value&&(this.value="")},window.input.onkeydown=e=>{if(e.stopPropagation(),13===e.keyCode||"Enter"===e.key){const t=String(e.target.value??"");t&&window.sendInfo(t)}},window.chatInput.add(window.ipt)}export{THROW_ITEMS,addChatWord,addClickEffect,closeEmojiDialog,closeLifesayDialog,createContentContainer,createDialogBase,createVoiceItem,exitThrowMode,getCurrentPlayer,hideDialog,hideOtherDialogs,initChatRecord,initChatSystem,isInThrowMode,processAudioPath,sendChatMessage,throwEmotion};
